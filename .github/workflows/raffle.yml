name: Raffle Processor

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Process issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const issue = context.payload.issue;
            const labels = (issue.labels || []).map(l => l.name);
            const body = issue.body || "";

            const dataPath = "data/results.json";
            const raw = fs.readFileSync(dataPath, "utf8");
            const db = JSON.parse(raw);

            const now = new Date().toISOString();

            function comment(msg) {
              return github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: msg
              });
            }

            function close() {
              return github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: "closed"
              });
            }

            function parseField(label) {
              // Issue forms 會變成：
              // ### 參加者代號
              // 7
              const re = new RegExp(`###\\s*${label}\\s*\\n+([\\s\\S]*?)(?=\\n###\\s|$)`, "m");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            function saveAndCommit(message) {
              db.updatedAt = now;
              fs.writeFileSync(dataPath, JSON.stringify(db, null, 2) + "\n", "utf8");

              const { execSync } = require('child_process');
              execSync('git config user.name "raffle-bot"');
              execSync('git config user.email "raffle-bot@users.noreply.github.com"');
              execSync(`git add ${dataPath}`);
              execSync(`git commit -m ${JSON.stringify(message)}`);
              execSync('git push');
            }

            // --- Admin actions ---
            if (labels.includes("admin")) {
              const action = parseField("操作");
              if (!action) {
                await comment("❌ 讀不到「操作」欄位，請用表單建立 Issue。");
                await close();
                return;
              }

              if (action === "set_participants") {
                const tp = parseInt(parseField("參加人數（set_participants 必填）"), 10);
                if (!Number.isInteger(tp) || tp <= 0 || tp > 10000) {
                  await comment("❌ 參加人數必須是正整數（建議不要超過 10000）。");
                  await close();
                  return;
                }
                db.totalParticipants = tp;
                // 不強制清票：你也可以改成設定人數就清票，看你習慣
                saveAndCommit(`admin: set participants = ${tp}`);
                await comment(`✅ 已設定參加人數：**${tp}**`);
                await close();
                return;
              }

              if (action === "reset_votes") {
                // 清空 votes / voteLog / votes 計數
                db.votes = {};
                db.voteLog = [];
                db.gifts = (db.gifts || []).map(g => ({ ...g, votes: 0 }));
                saveAndCommit("admin: reset votes");
                await comment("✅ 已重置：投票紀錄與票數統計已清空。");
                await close();
                return;
              }

              await comment("❌ 未知的 admin 操作。");
              await close();
              return;
            }

            // --- Vote ---
            if (labels.includes("vote")) {
              if (!db.totalParticipants || db.totalParticipants <= 0) {
                await comment("❌ 尚未設定參加人數。請管理員先用「管理員操作」Issue 設定。");
                await close();
                return;
              }

              const no = parseInt(parseField("參加者代號"), 10);
              if (!Number.isInteger(no) || no < 1 || no > db.totalParticipants) {
                await comment(`❌ 代號必須是 1 ~ ${db.totalParticipants} 的整數。`);
                await close();
                return;
              }

              const giftIdsRaw = parseField("投票禮物 ID（最多 3 個）");
              const giftIds = giftIdsRaw
                .split(",")
                .map(s => s.trim())
                .filter(Boolean);

              const maxVotes = db.maxVotesPerPerson || 3;
              const uniq = [...new Set(giftIds)];

              if (uniq.length === 0) {
                await comment("❌ 你沒有填任何禮物 ID。");
                await close();
                return;
              }
              if (uniq.length > maxVotes) {
                await comment(`❌ 每人最多投 ${maxVotes} 票，你填了 ${uniq.length} 個。`);
                await close();
                return;
              }

              // 同一代號只能投一次（最簡單好管）
              const key = String(no);
              if (db.votes && db.votes[key]) {
                await comment(`❌ 代號 **${no}** 已投過票了（為了公平，每個代號只能提交一次）。`);
                await close();
                return;
              }

              const giftSet = new Set((db.gifts || []).map(g => g.id));
              const invalid = uniq.filter(id => !giftSet.has(id));
              if (invalid.length) {
                await comment(`❌ 找不到禮物 ID：${invalid.join(", ")}（請確認 gifts 清單）。`);
                await close();
                return;
              }

              // 更新票數
              const gifts = db.gifts || [];
              for (const id of uniq) {
                const g = gifts.find(x => x.id === id);
                g.votes = (g.votes || 0) + 1;
              }

              db.votes = db.votes || {};
              db.votes[key] = { giftIds: uniq, ts: now, issue: issue.number };

              db.voteLog = db.voteLog || [];
              db.voteLog.push({ participantNo: no, giftIds: uniq, ts: now, issue: issue.number });

              saveAndCommit(`vote: #${no} -> ${uniq.join(",")}`);
              await comment(`✅ 投票成功：代號 **${no}** → **${uniq.join(", ")}**`);
              await close();
              return;
            }

            // Not our issue
            await comment("⚠️ 這個 Issue 沒有 vote/admin 標籤，因此不處理。");
            await close();
