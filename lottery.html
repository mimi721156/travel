<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°ç«¹æ¹–æ¿±æœƒé¤¨å°ˆå±¬ç¥¨é¸æ©Ÿ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* è·¨å¹´æ…¶å…¸ä¸»é¡Œé¡è‰²è¨­å®š */
        :root {
            --color-theme-blue: #1e40af; /* Deep Blue / Tailwind Blue-700 */
            --color-theme-gold: #fbbf24; /* Festive Gold / Tailwind Amber-400 */
            --color-theme-red: #dc2626; /* Accent Red / Tailwind Red-600 */
            --color-bg-light: #f3f4f6; /* Light Gray background */
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg-light); 
        }
        .container {
            max-width: 800px; 
        }
        @media (min-width: 1024px) { 
            .container {
                max-width: 1200px; 
            }
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
        }
        /* æ¨™é¡Œæ¨£å¼ */
        .theme-header {
            color: var(--color-theme-blue);
            text-shadow: 2px 2px 0px var(--color-theme-gold);
        }
        /* æäº¤æŒ‰éˆ• (Submit) */
        .btn-submit {
            background-color: var(--color-theme-blue);
            border: 2px solid #1e3a8a;
        }
        .btn-submit:hover {
            background-color: #1d4ed8;
        }
        /* å·²æäº¤è¨Šæ¯ (Submitted Message) */
        .btn-submitted {
            background-color: var(--color-theme-gold);
            color: #92400e; /* Brown text */
            border: 2pt solid #b45309;
        }
        /* é¸æ“‡æŒ‰éˆ• (Active Selection) */
        .btn-active-selection {
            background-color: var(--color-theme-red);
            border: 2pt solid #b91c1c;
            color: white;
        }
        .btn-active-selection:hover {
             background-color: #ef4444;
        }
        /* æ’åå¡ç‰‡ (Top 3) */
        .ranking-card-top {
            border: 4pt solid var(--color-theme-gold);
            background-color: #fffdf0; /* Very light yellow */
        }
        /* åœ–ç‰‡å¤§å°è¨­å®š */
        .gift-image-thumb {
            object-fit: cover;
        }
        .gift-image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }
        /* ç®¡ç†å“¡å‚™è¨»å€ç¸®åœ– */
        .admin-thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
        }
        /* å¯æ”¶æŠ˜å€å¡Šçš„å‹•ç•« */
        .collapsible-content {
            /* è®“ max-height è®Šå¾—æ¥µå¤§ï¼Œç¢ºä¿å…§å®¹ä¸æœƒè¢«é®æ“‹ï¼Œäº¤ç”± overflow: hidden æ§åˆ¶ */
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            overflow: hidden;
            max-height: 0; /* Default closed state */
        }
        
        /* NEW: å–è™Ÿæ©Ÿæ¨£å¼ - ç°¡æ½”æ¨¡å¼ */
        .draw-result-item {
            background-color: var(--color-theme-blue);
            color: white;
            padding: 0.5rem; /* ç¨å¾®ç¸®å°å…§è· */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-size: 1.5rem; /* èª¿æ•´å­—é«”å¤§å° */
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .draw-result-item:hover {
            transform: scale(1);
        }

        /* é †åºæ¨™ç±¤ (ç´…è‰²åœ“å½¢) */
        .draw-sequence-tag {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 24px;
            height: 24px;
            background-color: var(--color-theme-red);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* NEW: å€’æ•¸å‹•ç•«æ¨£å¼ */
        @keyframes border-glow {
            0%, 100% { border-color: var(--color-theme-red); box-shadow: 0 0 10px rgba(220, 38, 38, 0.5); }
            50% { border-color: var(--color-theme-gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); }
        }
        @keyframes text-pop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .reveal-countdown-box {
            animation: border-glow 1s infinite alternate;
        }
        .reveal-countdown-text {
            animation: text-pop 0.5s ease-in-out;
        }

        /* NEW: ç‘èŠ±å‹•ç•« (ç°¡å–®ç‰ˆæœ¬) */
        @keyframes confetti-fade-out {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background-color: var(--color-theme-gold); /* é è¨­é‡‘è‰² */
            animation: confetti-fade-out 1.5s ease-out;
            border-radius: 50%;
        }
        
        /* NEW: Modal åŸºç¤æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        /* NEW: æ´»å‹•æµç¨‹åˆ—è¡¨å„ªåŒ– - ç¸®æ’èˆ‡æ•¸å­—æ¨£å¼ */
        .flow-list {
            list-style-type: none; /* ç§»é™¤ç€è¦½å™¨é è¨­çš„æ•¸å­— */
            padding-left: 0;
            counter-reset: flow-step; /* å»ºç«‹è¨ˆæ•¸å™¨ */
        }
        .flow-list > li {
            counter-increment: flow-step; /* æ¯æ¬¡åˆ—è¡¨é …å¢åŠ è¨ˆæ•¸å™¨ */
            margin-bottom: 0.75rem; /* å¢åŠ è¡Œé–“è· */
            padding-left: 2.5rem; /* ç•™å‡ºç©ºé–“çµ¦è‡ªè¨‚æ•¸å­— */
            text-indent: -2.5rem; /* è² ç¸®æ’è®“æ•¸å­—åœ¨å·¦å´ */
            line-height: 1.5; /* ç¢ºä¿æŠ˜è¡Œæ–‡å­—æœ‰ç©ºé–“ */
            text-align: justify; /* ä¿æŒæ–‡å­—å°é½Š */
        }
        .flow-list > li::before {
            content: counter(flow-step) ". "; /* é¡¯ç¤ºè¨ˆæ•¸å™¨ */
            color: var(--color-theme-blue); /* æ­¥é©Ÿæ•¸å­—é¡è‰² */
            font-weight: 800; /* åŠ ç²—æ•¸å­— */
            display: inline-block;
            width: 2.5rem; /* æ•¸å­—å€å¡Šå¯¬åº¦ */
            text-align: right;
            padding-right: 0.5rem;
            flex-shrink: 0; /* é˜²æ­¢æ•¸å­—è¢«æ“ å£“ */
        }
        
        /* NEW: ç¢ºä¿å¡ç‰‡åº•éƒ¨å€åŸŸä¸€è‡´ï¼Œé˜²æ­¢è·‘ç‰ˆ */
        .reveal-card-footer {
            /* çµ¦äºˆè¶³å¤ ç©ºé–“å®¹ç´ç‹€æ…‹+select+button */
            min-height: 120px; 
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            align-items: center;
            padding-top: 0.5rem;
            width: 100%; 
        }
        /* é€ç¦®è€…ç‹€æ…‹å€åŸŸ (é¿å…ç°¡è¿°å’Œç‹€æ…‹é–“è·éå¤§ï¼Œä¸¦ç©©å®šé«˜åº¦) */
        .giver-status-area {
            width: 100%;
            min-height: 35px; /* ç¢ºä¿é€ç¦®è€…ç‹€æ…‹å€åŸŸæœ‰æœ€å°é«˜åº¦ */
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.5rem; /* æ¸›å°‘èˆ‡ä¸‹æ‹‰é¸å–®çš„é–“è· */
        }
        /* é€ç¦®è€…ä¸‹æ‹‰é¸å–®å’ŒæŒ‰éˆ•å€åŸŸ */
        .giver-controls {
            width: 100%;
            padding-top: 0.5rem; /* åˆ†éš”ç·šå’Œæ§åˆ¶é …ä¹‹é–“çš„é–“è· */
            border-top: 1px solid #e5e7eb; /* åˆ†éš”ç·š */
        }
    </style>
    <!-- Firebase å¼•å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Log Level for debugging
        setLogLevel('Debug');

        let app;
        let db;
        let auth; 
        
        let tempSelections = []; 

        // å…¨åŸŸè®Šæ•¸åˆå§‹åŒ–
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gift-exchange-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 


        // Firestore è·¯å¾‘
        const DATA_PATH = `artifacts/${appId}/public/data/gift_exchange_data`;
        const RESULTS_DOC_REF = (db) => doc(db, DATA_PATH, 'results');

        // **ç®¡ç†å“¡é–å®šç›¸é—œåƒæ•¸**
        const ADMIN_SESSION_DURATION = 600000; // 10 åˆ†é˜ (10 * 60 * 1000 ms)
        let adminUnlockedUntil = 0; // è§£é–æ™‚é–“æˆ³è¨˜

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ (State)
        const state = {
            gifts: [],
            votes: {}, 
            voterId: '', 
            voterStatus: 'pending', 
            currentUserVotes: [], 
            loading: true,
            page: 'intro', // é è¨­é é¢æ”¹ç‚º intro
            message: null,
            tempGiftImageBase64: null,
            adminPassword: 'miao1004', 
            totalParticipants: 0, 
            isAdminLocked: true, // åˆå§‹é–å®šç‹€æ…‹
            // ** NEW: å…¨å±€é…ç½® **
            appTitle: 'æ–°ç«¹æ¹–æ¿±æœƒé¤¨å°ˆå±¬ç¥¨é¸æ©Ÿ',
            voteInstruction: 'è«‹åœ¨çœ¾å¤šç¦®ç‰©ä¸­ï¼Œé¸å‡ºæ‚¨å¿ƒç›®ä¸­æœ€çˆ›çš„ 1 åˆ° 3 å€‹ç¦®ç‰©ï¼',
            introHeading: 'è¦ªæ„›çš„å®¶äººå€‘ï¼Œæ­¡è¿åƒåŠ è·¨å¹´äº¤æ›ç¦®ç‰©è¶´ï¼', 
            introSubtext: 'è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æŠ½å–æ‚¨çš„ä»£è™Ÿï¼Œæˆ–ç›´æ¥é€²å…¥æŠ•ç¥¨å€ã€‚', 
            rulesHeading: 'ğŸ“œ äº¤æ›ç¦®ç‰©æ³¨æ„è¦å‰‡', // NEW
            rulesContent: `ğŸ ç¦®ç‰©è¦ç¯„
é ç®—ï¼šæ¯äºº 500 å…ƒå…§
ä¸»é¡Œï¼šç™‚ç™’å°ç‰©ï¼ˆé¦™æ°›ã€èˆ’å£“ã€æŠ±æ•ã€æ³¡æ¾¡çƒç­‰ï¼‰
é¸ä½ è‡ªå·±ä¹Ÿæœƒæƒ³æ”¶åˆ°ã€çœ‹äº†å°±èˆ’æœçš„æ±è¥¿
ğŸš« ç¦ç‰©å°æé†’
èˆ‡ã€Œé«˜ 1nã€æœ‰é—œç‰©å“ï¼ˆé˜¿å…¬ / é˜¿åª½ / é«˜ nn ç„¡é™åˆ¶ï¼‰
ç¾é‡‘æˆ–åªåŒ…ç´…åŒ…ï¼ˆè¦ä¿ç•™æ‹†ç¦®ç‰©é©šå–œæ„Ÿï¼‰
ğŸ¤ åŒ¿åè¦å‰‡ï¼ˆéå¸¸é‡è¦ï¼‰
æ‹†ç¦®ç‰©æœŸé–“ï¼Œä¸å¾—é€éœ²ç¦®ç‰©æ˜¯å¦ç‚ºè‡ªå·±æº–å‚™
ä¸å¯ç”¨èªæ°£ã€è¡¨æƒ…ã€çœ¼ç¥æš—ç¤º
ä¸å¾—çˆ†é›·ã€ä¸æç¤ºã€ä¸è§£é‡‹
å®Œå…¨åŒ¿åç›´åˆ°ã€Œæ­éœ²éšæ®µã€
ğŸ—³ï¸ æŠ•ç¥¨è¦å‰‡
æŠ•ç¥¨å‰éœ€é¸æ“‡è‡ªå·±çš„è™Ÿç¢¼ä½œç‚ºèº«åˆ†ä»£ç¢¼
æ¯äººæœ€å°‘ 1 ç¥¨ã€æœ€å¤š 3 ç¥¨
æŠ•ç¥¨è©•é¸ã€Œæœ€é›·ç¦®ç‰©å‰ä¸‰åã€
æŠ•ç¥¨çµæŸå¾Œä¸å¾—è£œç¥¨æˆ–ä¿®æ”¹
ğŸ† æ’è¡Œèˆ‡æ‡²ç½°æ©Ÿåˆ¶
æ‰€æœ‰äººæ­éœ²é€ç¦®äººå¾Œ
æ’è¡Œæ¦œæ­ç¤º
æœ€é›·å‰ä¸‰å â†’ è«‹å…¨å®¶å–é£²æ–™`, // NEW
            flowHeading: 'âœ… æ´»å‹•æµç¨‹ (7 æ­¥é©Ÿ)', // NEW
            flowContent: '1. æŠ½ç±¤ï¼šä¸»è¾¦æ–¹ç™¼æ”¾ç´™ç±¤ï¼Œæ‰€æœ‰äººä¾åºæŠ½ç±¤ã€‚\n2. è¦å‰‡èªªæ˜ï¼šä¸»è¾¦æ–¹é–‹å•Ÿç³»çµ±ï¼Œå¤§è¢å¹•é¡¯ç¤ºæ´»å‹•è¦å‰‡èˆ‡æ³¨æ„äº‹é …ã€‚\n3. æ±ºå®šæ‹†ç¦®ç‰©é †åºï¼šä¸»è¾¦æ–¹å•Ÿå‹•ã€Œæ‹†ç¦®ç‰©é †åºæ©Ÿã€ï¼Œå…¬å¸ƒè™Ÿç¢¼é †åºï¼Œä¾åºä¸Šå‰æ‹†ç¦®ç‰©ã€‚\n4. æ‹†ç¦®ç‰©ï¼ˆåŒ¿åéšæ®µï¼‰ï¼šæŠ½åˆ°è™Ÿç¢¼è€…ä¾é †åºæ‹†ç¦®ç‰©ï¼Œä»»ä½•äººä¸å¾—è¡¨æ…‹ç¦®ç‰©æ˜¯å¦è‡ªå·±æº–å‚™çš„ã€‚ä¸»è¾¦æ–¹å°‡æ¯ä»½ç¦®ç‰©æ‹ç…§ä¸¦ç™»éŒ„è‡³ç³»çµ±ã€‚\n5. æŠ•ç¥¨ï¼šæ‰€æœ‰ç¦®ç‰©æ‹†å®Œå¾Œï¼Œä¸»è¾¦æ–¹é–‹å•ŸæŠ•ç¥¨å€ï¼Œæ¯äººç™»å…¥å¾Œéœ€é¸æ“‡è‡ªå·±çš„è™Ÿç¢¼ä½œç‚ºä»£ç¢¼ï¼Œæ¯äººæœ€å°‘æŠ• 1 ç¥¨ã€æœ€å¤š 3 ç¥¨ï¼Œé¸å‡ºã€Œæœ€é›·çš„ç¦®ç‰©ã€ã€‚\n6. æ­éœ²é€ç¦®äººï¼šæŠ•ç¥¨çµæŸå¾Œï¼Œä¸»è¾¦æ–¹é–‹å•Ÿç¦®ç‰©åˆ—è¡¨ï¼Œä¾ç¦®ç‰©é€ä¸€å”±åï¼Œå¤§å®¶ä¾åºå…¬å¸ƒè©²ç¦®ç‰©æ˜¯è‡ªå·±æº–å‚™çš„ï¼Œä¸»è¾¦æ–¹ç™»éŒ„é€ç¦®äººè³‡è¨Šè‡³ç³»çµ±ã€‚\n7. æ’è¡Œçµæœï¼šä¸»è¾¦æ–¹æŒ‰ä¸‹ã€Œæ’è¡Œæ¦œæ­éœ²ã€ï¼Œç³»çµ±å…¬å¸ƒæœ€çµ‚åæ¬¡ã€‚æœ€é›·å‰ä¸‰åçš„é€ç¦®äººé ˆè«‹å…¨å®¶å–é£²æ–™ã€‚', // NEW
            honorRanks: 3, 
            prizeDescription: 'æ¦®ç²è«‹å®¢ä¸€æ¯é£²æ–™çš„æ®Šæ¦®ï¼',
            // ** NEW: å…¬å¸ƒç‹€æ…‹é– **
            isRankingPublic: false,
            revealCountdown: 0,
            isConfigOpen: false, // é è¨­é—œé–‰æ”¶æŠ˜
            isHighRiskOpen: false, // NEW: é«˜é¢¨éšªå€å¡Šæ”¶æŠ˜ç‹€æ…‹
            isRulesModalOpen: false, // NEW: è¦å‰‡è·³çª—ç‹€æ…‹
            isFlowModalOpen: false, // NEW: æµç¨‹è·³çª—ç‹€æ…‹
            // ** NEW: å–è™Ÿæ©Ÿç‹€æ…‹ **
            drawResults: [],
            // ** NEW: è™Ÿç¢¼å‚™è¨»ç›¸é—œ **
            participantNames: {}, // { '1': 'å°æ˜', '2': 'å°è¯' }
            isRemarkModalOpen: false, 
            currentRemarkNumber: null,
            MAX_NAME_LENGTH: 5, // åå­—é™åˆ¶
        };

        // åˆå§‹ç¦®ç‰©æ¸…å–®
        const initialGifts = [];
        const MAX_VOTES = 3; // **æœ€å¤šç¥¨æ•¸é™åˆ¶**

        // --- Firebase åˆå§‹åŒ– ---
        const initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                state.message = "Firebase è¨­å®šéºå¤±ï¼Œè«‹æª¢æŸ¥ç’°å¢ƒè¨­å®šã€‚";
                renderApp();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // èªè­‰æµç¨‹ (æ»¿è¶³ Canvas ç’°å¢ƒè¦æ±‚)
                auth = getAuth(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); 
                }

                state.loading = false;
                setupRealtimeListener();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                state.message = `Firebase åˆå§‹åŒ–éŒ¯èª¤: ${error.message}`;
                state.loading = false;
                renderApp();
            }
        };

        // --- Firestore å¯¦æ™‚ç›£è½ ---
        const setupRealtimeListener = () => {
            if (!db) return;

            onSnapshot(RESULTS_DOC_REF(db), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.gifts = data.gifts || [];
                    state.votes = data.votes || {};
                    state.totalParticipants = data.totalParticipants || 0; 
                    state.participantNames = data.participantNames || {}; // <-- NEW: è®€å–å‚™è¨»åç¨±
                    
                    // NEW: è®€å–é…ç½®
                    state.appTitle = data.appTitle || state.appTitle;
                    state.voteInstruction = data.voteInstruction || state.voteInstruction; 
                    state.introHeading = data.introHeading || state.introHeading; 
                    state.introSubtext = data.introSubtext || state.introSubtext; 
                    state.rulesHeading = data.rulesHeading || state.rulesHeading; 
                    state.rulesContent = data.rulesContent || state.rulesContent; 
                    state.flowHeading = data.flowHeading || state.flowHeading; // NEW
                    state.flowContent = data.flowContent || data.flowContent; // NEW
                    state.honorRanks = data.honorRanks !== undefined ? data.honorRanks : state.honorRanks;
                    state.prizeDescription = data.prizeDescription || state.prizeDescription;
                    state.isRankingPublic = data.isRankingPublic || false;

                    selectVoterId(state.voterId, false); 

                } else {
                    // åˆå§‹åŒ–æ–‡æª”æ™‚åŠ å…¥ participantNames
                    setDoc(RESULTS_DOC_REF(db), { gifts: initialGifts, votes: {}, totalParticipants: 0, appTitle: state.appTitle, honorRanks: state.honorRanks, prizeDescription: state.prizeDescription, voteInstruction: state.voteInstruction, introHeading: state.introHeading, introSubtext: state.introSubtext, rulesHeading: state.rulesHeading, rulesContent: state.rulesContent, flowHeading: state.flowHeading, flowContent: state.flowContent, isRankingPublic: false, participantNames: {} }, { merge: true }).catch(err => console.error("Initial set error:", err));
                }
                renderApp();
            }, (error) => {
                console.error("Firestore Listen Error:", error);
                state.message = `æ•¸æ“šåŒæ­¥éŒ¯èª¤: ${error.message}`;
                renderApp();
            });
        };

        // --- è™•ç†æŠ•ç¥¨è€…ä»£è™Ÿé¸æ“‡ (å¾æŒ‰éˆ•é»æ“Šæˆ–æ•¸æ“šç›£è½å™¨è§¸ç™¼) ---
        const selectVoterId = (id, shouldRender = true) => {
            const voterId = String(id).trim();
            state.voterId = voterId;
            tempSelections = [];

            if (voterId.length === 0) {
                state.voterStatus = 'pending';
                state.currentUserVotes = [];
            } else if (state.votes[voterId] && Array.isArray(state.votes[voterId]) && state.votes[voterId].length > 0) {
                state.voterStatus = 'has_voted';
                state.currentUserVotes = state.votes[voterId];
            } else {
                state.voterStatus = 'can_vote';
                state.currentUserVotes = [];
            }

            if (shouldRender) {
                renderApp();
            }
        };

        // è¼”åŠ©å‡½æ•¸ï¼šåˆ‡æ›ä»£è™Ÿ/æ¸…ç©ºç•¶å‰é¸æ“‡
        const handleVoterSwitch = () => {
            selectVoterId('', true); 
        }


        // --- æ ¸å¿ƒé‚è¼¯ï¼šæœ¬åœ°é¸æ“‡åŠŸèƒ½ (éå³æ™‚å¯«å…¥ Firestore) ---
        const handleSelection = (giftId) => {
            if (state.voterStatus !== 'can_vote') {
                state.message = "è«‹å…ˆé¸æ“‡æœ‰æ•ˆçš„æŠ•ç¥¨ä»£è™Ÿï¼Œæˆ–æ‚¨çš„ä»£è™Ÿå·²æäº¤éæŠ•ç¥¨ï¼";
                renderApp();
                return;
            }

            const index = tempSelections.indexOf(giftId);
            if (index > -1) {
                // å–æ¶ˆé¸æ“‡ (å·²é¸é)
                tempSelections.splice(index, 1);
                state.message = `å–æ¶ˆé¸æ“‡ï¼šé‚„å‰© ${MAX_VOTES - tempSelections.length} ç¥¨å¯æŠ•`;
            } else if (tempSelections.length < MAX_VOTES) {
                // é¸æ“‡ (æœªé¸éä¸”æœªæ»¿ 3 ç¥¨)
                tempSelections.push(giftId);
                state.message = `é¸æ“‡æˆåŠŸï¼šé‚„å‰© ${MAX_VOTES - tempSelections.length} ç¥¨å¯æŠ•`;
            } else {
                // è¶…é 3 ç¥¨
                state.message = `æ¯äººæœ€å¤šåªèƒ½æŠ• ${MAX_VOTES} ç¥¨ï¼è«‹å–æ¶ˆé¸æ“‡ä¸€é …å¾Œå†è©¦ã€‚`;
            }
            renderApp();
        };

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæäº¤æŠ•ç¥¨ (å¯«å…¥ Firestore) ---
        const handleSubmitVotes = async () => {
            if (state.voterStatus !== 'can_vote' || !db) {
                state.message = "ç‹€æ…‹éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡ä»£è™Ÿæˆ–æª¢æŸ¥é€£ç·šã€‚";
                renderApp();
                return;
            }

            if (tempSelections.length === 0) {
                state.message = "è«‹è‡³å°‘æŠ• 1 ç¥¨æ‰èƒ½é€å‡ºï¼";
                renderApp();
                return;
            }
            
            const voterIdKey = state.voterId;
            const votesToSubmit = tempSelections.slice(0, MAX_VOTES);

            try {
                await runTransaction(db, async (transaction) => {
                    const docRef = RESULTS_DOC_REF(db);
                    const doc = await transaction.get(docRef);

                    if (!doc.exists()) {
                        throw new Error(`Document does not exist! Voter ID: ${voterIdKey}`);
                    }

                    const data = doc.data();
                    const newVotes = { ...data.votes };

                    // **é‡è¦ï¼šä½¿ç”¨ voterIdKey æª¢æŸ¥æ˜¯å¦å·²æŠ•ç¥¨**
                    if (newVotes[voterIdKey] && newVotes[voterIdKey].length > 0) {
                         throw new Error(`ä»£è™Ÿ ${voterIdKey} å·²æäº¤éæŠ•ç¥¨ã€‚`);
                    }

                    // è¨˜éŒ„ç•¶å‰ç”¨æˆ¶çš„æŠ•ç¥¨é™£åˆ— (é€™ä¸€æ­¥å³é–å®šæŠ•ç¥¨)
                    newVotes[voterIdKey] = votesToSubmit;

                    // æ›´æ–°æ•¸æ“š
                    transaction.update(docRef, { votes: newVotes });
                });

                // æäº¤æˆåŠŸå¾Œ
                state.currentUserVotes = votesToSubmit;
                tempSelections = [];
                state.voterStatus = 'has_voted'; // ç«‹å³åˆ‡æ›ç‹€æ…‹
                state.message = `ğŸ‰ ä»£è™Ÿ ${voterIdKey} æˆåŠŸé€å‡º ${votesToSubmit.length} ç¥¨ï¼æŠ•ç¥¨å·²é–å®šã€‚`;
                renderApp();

            } catch (error) {
                console.error("Transaction failed:", error);
                state.message = `æŠ•ç¥¨é€å‡ºå¤±æ•—: ${error.message}`;
                // å¦‚æœæ˜¯é‡è¤‡æäº¤çš„éŒ¯èª¤ï¼Œå‰‡æ›´æ–°ç‹€æ…‹
                if (error.message.includes("å·²æäº¤éæŠ•ç¥¨")) {
                    selectVoterId(state.voterId, true);
                }
                renderApp();
            }
        };

        // --- ç®¡ç†åŠŸèƒ½ï¼šé©—è­‰å¯†ç¢¼ä¸¦è¨­å®šé–å®šæ™‚é–“ ---
        const checkAdminLock = (password) => {
            // æª¢æŸ¥æ˜¯å¦ä»åœ¨è§£é–æ™‚é–“å…§
            const timeRemaining = adminUnlockedUntil - Date.now();
            if (timeRemaining > 0) {
                state.isAdminLocked = false;
                return true;
            }
            
            // æª¢æŸ¥å¯†ç¢¼
            if (password === state.adminPassword) {
                adminUnlockedUntil = Date.now() + ADMIN_SESSION_DURATION;
                state.isAdminLocked = false;
                state.message = `âœ… ç®¡ç†å“¡æ¨¡å¼å·²è§£é–ï¼${formatTimeRemaining(ADMIN_SESSION_DURATION)} å…§ç„¡éœ€å†æ¬¡è¼¸å…¥å¯†ç¢¼ã€‚`;
                return true;
            } else {
                state.message = "ç®¡ç†å¯†ç¢¼éŒ¯èª¤ï¼";
                state.isAdminLocked = true;
                return false;
            }
        }
        
        // --- NEW: æ™‚é–“æ ¼å¼åŒ– M:SS ---
        const formatTimeRemaining = (ms) => {
            if (ms <= 0) return "00:00";
            const totalSeconds = Math.ceil(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        };

        // --- ç®¡ç†åŠŸèƒ½ï¼šåŸ·è¡Œç®¡ç†æ“ä½œ ---
        const handleAdminAction = async (action, giftId = null) => {
            const passwordInput = document.getElementById('admin-password');
            const password = passwordInput ? passwordInput.value : '';

            // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™ (é©ç”¨æ–¼æ‰€æœ‰éœ€è¦é–çš„æ“ä½œ)
            const UNLOCKED_ACTIONS = ['lock-check', 'manual-lock', 'update-giver', 'publish-ranking', 'unpublish-ranking', 'set-participants', 'clear-participants', 'clear-giver', 'update-participant-name'];
            
            // NOTE: set-participants, update-giver, publish/unpublish ranking, clear-giver, update-participant-name ä¸éœ€è¦å¯†ç¢¼ï¼Œä½† clear-participants, reset éœ€è¦
            const needsPasswordCheck = (action === 'clear-participants' || action === 'reset');

            if (needsPasswordCheck) {
                 if (state.isAdminLocked) {
                    if (!checkAdminLock(password)) {
                        renderApp(); 
                        return;
                    }
                } else {
                    if (passwordInput) passwordInput.value = '';
                }
            }


            const docRef = RESULTS_DOC_REF(db);
            
            // --- åŸ·è¡Œå…·é«”æ“ä½œ ---
            if (action === 'manual-lock') {
                adminUnlockedUntil = Date.now(); // ç«‹å³å°‡è§£é–æ™‚é–“è¨­ç‚ºç¾åœ¨
                state.isAdminLocked = true;
                state.message = "ç®¡ç†å“¡æœƒè©±å·²æ‰‹å‹•é–å®šã€‚";
            } else if (action === 'reset') {
                const resetPassword = document.getElementById('reset-password');
                if (!resetPassword || resetPassword.value !== state.adminPassword) {
                    state.message = "é‡ç½®éŠæˆ²éœ€è¦æ­£ç¢ºçš„ç®¡ç†å¯†ç¢¼ï¼";
                    renderApp();
                    return;
                }

                try {
                    document.getElementById('reset-password').value = '';
                    // é‡ç½®æ™‚åŠ å…¥ participantNames
                    await setDoc(docRef, { gifts: initialGifts, votes: {}, totalParticipants: 0, appTitle: state.appTitle, honorRanks: state.honorRanks, prizeDescription: state.prizeDescription, voteInstruction: state.voteInstruction, introHeading: state.introHeading, introSubtext: state.introSubtext, rulesHeading: state.rulesHeading, rulesContent: state.rulesContent, flowHeading: state.flowHeading, flowContent: state.flowContent, isRankingPublic: false, participantNames: {} }); 
                    state.currentUserVotes = [];
                    state.drawResults = []; // é‡ç½®å–è™Ÿçµæœ
                    tempSelections = [];
                    state.voterId = '';
                    state.voterStatus = 'pending';
                    state.totalParticipants = 0;
                    state.message = "ğŸ‰ éŠæˆ²å·²å®Œå…¨é‡ç½®ï¼ç¦®ç‰©æ¸…å–®å’Œç¥¨æ•¸çš†å·²æ¸…ç©ºã€‚";
                } catch (error) {
                    console.error("Reset failed:", error);
                    state.message = `é‡ç½®å¤±æ•—: ${error.message}`;
                }
            } else if (action === 'add-gift') {
                const newDescription = document.getElementById('new-description').value.trim();

                if (!newDescription) {
                    state.message = "è«‹å¡«å¯«ç¦®ç‰©æè¿°ã€‚";
                    renderApp();
                    return;
                }

                const newGift = {
                    id: crypto.randomUUID(),
                    giver: '', 
                    description: newDescription,
                    image: state.tempGiftImageBase64 
                };

                try {
                    await runTransaction(db, async (transaction) => {
                        const doc = await transaction.get(docRef);
                        const data = doc.data();
                        const updatedGifts = [...(data.gifts || []), newGift];
                        transaction.update(docRef, { votes: data.votes || {}, gifts: updatedGifts });
                    });
                    
                    document.getElementById('new-description').value = '';
                    const imageInput = document.getElementById('gift-image-input');
                    if (imageInput) imageInput.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥
                    state.tempGiftImageBase64 = null;

                    state.message = `ğŸ æˆåŠŸæ–°å¢ç¦®ç‰©ï¼š${newDescription}`;
                } catch (error) {
                    console.error("Add gift failed:", error);
                    state.message = `æ–°å¢ç¦®ç‰©å¤±æ•—: ${error.message}`;
                }
            } else if (action === 'set-participants') {
                // NOTE: æ­¤è™•ä¸éœ€å¯†ç¢¼
                const countInput = document.getElementById('participant-count');
                const count = parseInt(countInput.value);

                if (isNaN(count) || count <= 0) {
                    state.message = "åƒåŠ äººæ•¸å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ­£æ•´æ•¸ï¼";
                    renderApp();
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦å·²è¨­å®šéï¼Œå¦‚æœå·²è¨­å®šå‰‡ä¸å…è¨±é€éé€™å€‹è·¯å¾‘æ›´æ”¹
                if (state.totalParticipants > 0) {
                    state.message = "åƒåŠ äººæ•¸å·²è¨­å®šï¼Œå¦‚éœ€é‡è¨­è«‹å‰å¾€é«˜é¢¨éšªæ“ä½œå€ã€‚";
                    renderApp();
                    return;
                }

                try {
                    await setDoc(docRef, { totalParticipants: count }, { merge: true });
                    state.totalParticipants = count;
                    state.message = `âœ… æˆåŠŸè¨­å®šåƒåŠ äººæ•¸ç‚º ${count} äººï¼`;
                } catch (error) {
                    console.error("Set participants failed:", error);
                    state.message = `è¨­å®šäººæ•¸å¤±æ•—: ${error.message}`;
                }
            } else if (action === 'clear-participants') {
                 // ** NEW: æ¸…é™¤åƒåŠ äººæ•¸åŠŸèƒ½ - éœ€å¯†ç¢¼ **
                const clearPassword = document.getElementById('clear-participants-password').value;
                if (clearPassword !== state.adminPassword) {
                    state.message = "æ¸…é™¤äººæ•¸éœ€è¦æ­£ç¢ºçš„ç®¡ç†å¯†ç¢¼ï¼";
                    renderApp();
                    return;
                }
                
                try {
                    document.getElementById('clear-participants-password').value = '';
                    // æ¸…é™¤äººæ•¸æ™‚ï¼Œæ¸…ç©º participantNames
                    await setDoc(RESULTS_DOC_REF(db), { totalParticipants: 0, participantNames: {} }, { merge: true });
                    state.message = `âœ… åƒåŠ äººæ•¸å·²æ¸…é™¤ï¼è«‹åœ¨å–è™Ÿæ©Ÿé é¢é‡æ–°è¨­å®šã€‚`;
                    state.totalParticipants = 0; // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                    state.drawResults = []; // æ¸…ç©ºæŠ½è™Ÿçµæœ
                } catch (error) {
                    state.message = `æ¸…é™¤äººæ•¸å¤±æ•—: ${error.message}`;
                }

            } else if (action === 'update-giver' && giftId) {
                // NOTE: æ­¤è™•ä¸éœ€å¯†ç¢¼
                const selectElement = document.getElementById(`reveal-input-${giftId}`); // Changed to select element
                const newGiverName = selectElement ? selectElement.value.trim() : '';

                try {
                     await runTransaction(db, async (transaction) => {
                        const doc = await transaction.get(docRef);
                        const data = doc.data();
                        const updatedGifts = (data.gifts || []).map((gift) => {
                            if (gift.id === giftId) {
                                return { ...gift, giver: newGiverName };
                            }
                            return gift;
                        });
                        transaction.update(docRef, { gifts: updatedGifts });
                    });
                    state.message = `âœ… ç¦®ç‰© ID ${giftId.substring(0, 4)} çš„é€ç¦®è€…å·²å‚™è¨»ç‚ºï¼š${newGiverName || 'ç„¡'}`;
                } catch (error) {
                    console.error("Update giver failed:", error);
                    state.message = `å‚™è¨»é€ç¦®è€…å¤±æ•—: ${error.message}`;
                }

            } else if (action === 'clear-giver' && giftId) {
                 // ** NEW: æ¸…é™¤å–®ä¸€é€ç¦®è€…å‚™è¨»åŠŸèƒ½ - éœ€å¯†ç¢¼ **
                 if (passwordInput && passwordInput.value !== state.adminPassword) {
                     state.message = "æ¸…é™¤å‚™è¨»éœ€è¦ç®¡ç†å¯†ç¢¼ï¼";
                     renderApp();
                     return;
                 }
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const doc = await transaction.get(docRef);
                        const data = doc.data();
                        const updatedGifts = (data.gifts || []).map((gift) => {
                            if (gift.id === giftId) {
                                return { ...gift, giver: '' }; // æ¸…ç©ºå‚™è¨»
                            }
                            return gift;
                        });
                        transaction.update(docRef, { gifts: updatedGifts });
                    });
                    state.message = `âœ… ç¦®ç‰© ID ${giftId.substring(0, 4)} çš„é€ç¦®è€…å‚™è¨»å·²æ¸…é™¤ã€‚`;
                } catch (error) {
                    state.message = `æ¸…é™¤å‚™è¨»å¤±æ•—: ${error.message}`;
                }
            } else if (action === 'update-participant-name') {
                const number = state.currentRemarkNumber;
                const name = document.getElementById('remark-name-input').value.trim();
                
                if (!number) return; 

                if (name.length > state.MAX_NAME_LENGTH) {
                    state.message = `å‚™è¨»åå­—æœ€å¤šé™åˆ¶ ${state.MAX_NAME_LENGTH} å€‹å­—ï¼`;
                    // ä¸é—œé–‰ Modal
                    renderApp();
                    return;
                }

                try {
                    await runTransaction(db, async (transaction) => {
                        const docRef = RESULTS_DOC_REF(db);
                        const doc = await transaction.get(docRef);
                        const data = doc.data();
                        
                        const newNames = { ...data.participantNames };
                        
                        if (name.length === 0) {
                            delete newNames[number]; // å…è¨±æ¸…ç©º
                        } else {
                            newNames[number] = name;
                        }
                        
                        transaction.update(docRef, { participantNames: newNames });
                    });

                    // é—œé–‰ Modalï¼Œä¸¦é‡ç½®ç‹€æ…‹
                    state.isRemarkModalOpen = false;
                    state.currentRemarkNumber = null;
                    state.message = `âœ… è™Ÿç¢¼ ${number} å·²å‚™è¨»ç‚º ${name || 'ç„¡'}ã€‚`;
                    // Rerender will happen via listener anyway, but this updates UI immediately.
                } catch (error) {
                    console.error("Update name failed:", error);
                    state.message = `å‚™è¨»åå­—å¤±æ•—: ${error.message}`;
                }
            } else if (action === 'force-remove-vote') {
                const removeIdInput = document.getElementById('remove-voter-id');
                const removeId = removeIdInput.value.trim();

                if (removeId.length === 0) {
                    state.message = "è«‹è¼¸å…¥æœ‰æ•ˆçš„ç·¨è™Ÿã€‚";
                    renderApp();
                    return;
                }

                try {
                    await runTransaction(db, async (transaction) => {
                        const doc = await transaction.get(docRef);
                        const data = doc.data();
                        const newVotes = { ...data.votes };

                        if (!newVotes[removeId]) {
                            state.message = `ç·¨è™Ÿ ${removeId} æŸ¥ç„¡æŠ•ç¥¨ç´€éŒ„ã€‚`;
                            return;
                        }

                        delete newVotes[removeId];
                        transaction.update(docRef, { votes: newVotes });
                    });
                    
                    removeIdInput.value = '';
                    state.message = `âœ… ç·¨è™Ÿ ${removeId} çš„æŠ•ç¥¨ç´€éŒ„å·²å¼·åˆ¶ç§»é™¤ï¼`;
                } catch (error) {
                    console.error("Force removal failed:", error);
                    state.message = `å¼·åˆ¶ç§»é™¤å¤±æ•—: ${error.message}`;
                }
            } else if (action === 'publish-ranking') {
                // NOTE: æ­¤è™•ä¸éœ€å¯†ç¢¼
                 try {
                    await setDoc(docRef, { isRankingPublic: true, isRevealing: true }, { merge: true });
                    state.isRankingPublic = true;
                    state.page = 'ranking'; // ç«‹å³åˆ‡æ›åˆ°çµæœæ’åé¢æ¿
                    state.message = `ğŸ‰ æ’è¡Œæ¦œå·²å…¬é–‹ï¼æ­£åœ¨é–‹å§‹å€’æ•¸æ­éœ²...`;
                    window.startRevealCountdown();
                } catch (error) {
                    state.message = `å…¬å¸ƒå¤±æ•—: ${error.message}`;
                }
            } else if (action === 'unpublish-ranking') {
                // NOTE: æ­¤è™•ä¸éœ€å¯†ç¢¼
                 try {
                    await setDoc(docRef, { isRankingPublic: false, isRevealing: false }, { merge: true });
                    state.isRankingPublic = false;
                    state.message = `âŒ æ’è¡Œæ¦œå·²æ’¤éŠ·å…¬å¸ƒï¼`;
                } catch (error) {
                    state.message = `æ’¤éŠ·å¤±æ•—: ${error.message}`;
                }
            } else if (action === 'update-config') {
                 // NEW: æ›´æ–°é…ç½®
                const newTitle = document.getElementById('config-title').value.trim();
                const newVoteInstruction = document.getElementById('config-vote-instruction').value.trim(); 
                const newIntroHeading = document.getElementById('config-intro-heading').value.trim(); 
                const newIntroSubtext = document.getElementById('config-intro-subtext').value.trim(); 
                const newRulesHeading = document.getElementById('config-rules-heading').value.trim(); 
                const newRulesContent = document.getElementById('config-rules-content').value.trim(); 
                const newFlowHeading = document.getElementById('config-flow-heading').value.trim(); 
                const newFlowContent = document.getElementById('config-flow-content').value.trim(); 
                const newRanks = parseInt(document.getElementById('config-honor-ranks').value);
                const newPrize = document.getElementById('config-prize-desc').value.trim();

                if (newTitle.length === 0 || newVoteInstruction.length === 0 || newIntroHeading.length === 0 || newIntroSubtext.length === 0 || newRulesHeading.length === 0 || newRulesContent.length === 0 || newFlowHeading.length === 0 || newFlowContent.length === 0 || isNaN(newRanks) || newRanks < 0 || newRanks > 3) {
                     state.message = "é…ç½®è¨­å®šç„¡æ•ˆï¼æ‰€æœ‰é…ç½®æ¬„ä½ (æ¨™é¡Œã€èªªæ˜ã€è¦å‰‡ã€æµç¨‹) ä¸å¯ç‚ºç©ºï¼Œæ¦®è€€çé …æ•¸å¿…é ˆä»‹æ–¼ 0 åˆ° 3 ä¹‹é–“ã€‚";
                     return;
                }
                 try {
                    await setDoc(docRef, { 
                        appTitle: newTitle, 
                        voteInstruction: newVoteInstruction, 
                        introHeading: newIntroHeading, 
                        introSubtext: newIntroSubtext, 
                        rulesHeading: newRulesHeading, 
                        rulesContent: newRulesContent, 
                        flowHeading: newFlowHeading, 
                        flowContent: newFlowContent, 
                        honorRanks: newRanks, 
                        prizeDescription: newPrize 
                    }, { merge: true });
                    state.message = `âœ… æ‡‰ç”¨ç¨‹å¼é…ç½®å·²æ›´æ–°ï¼`;
                } catch (error) {
                     state.message = `é…ç½®æ›´æ–°å¤±æ•—: ${error.message}`;
                }
            }

            renderApp();
        };
        
        // NEW: æ’åæ­éœ²å€’æ•¸è¨ˆæ™‚å™¨
        let revealTimer = null;
        window.startRevealCountdown = () => {
            if (revealTimer) clearInterval(revealTimer);
            state.revealCountdown = 5;
            renderApp();
            
            const docRef = RESULTS_DOC_REF(db);

            revealTimer = setInterval(async () => {
                if (state.revealCountdown > 0) {
                    state.revealCountdown--;
                    renderApp();
                } else {
                    clearInterval(revealTimer);
                    revealTimer = null;
                    // å€’æ•¸çµæŸï¼Œå°‡æ­éœ²ç‹€æ…‹è¨­ç‚º falseï¼Œé¿å…æŒçºŒæ›´æ–°
                    try {
                        await setDoc(docRef, { isRevealing: false }, { merge: true });
                    } catch (e) {
                        console.error("Failed to unset isRevealing", e);
                    }
                    state.message = 'ğŸš€ æ’è¡Œæ¦œçµæœå·²æ­æ›‰ï¼';
                    window.addConfettiEffect(); // è§¸ç™¼ç‘èŠ±æ•ˆæœ
                    renderApp();
                }
            }, 1000);
        };


        // --- åœ–ç‰‡è™•ç† (æ–°å¢å£“ç¸®é‚è¼¯) ---
        const handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) {
                 state.tempGiftImageBase64 = null;
                 const previewElement = document.getElementById('image-preview');
                 if (previewElement) previewElement.src = 'https://placehold.co/80x80/cccccc/333333?text=é è¦½';
                 renderApp();
                 return;
            }

            // è®€å–æª”æ¡ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const MAX_WIDTH = 400; // æœ€å¤§å¯¬åº¦
                    const MAX_HEIGHT = 400; // æœ€å¤§é«˜åº¦
                    let width = img.width;
                    let height = img.height;

                    // è¨ˆç®—æ–°çš„å°ºå¯¸ä»¥ç¬¦åˆ 400px å…§çš„é™åˆ¶
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // è¼¸å‡ºå£“ç¸®å¾Œçš„ Base64 å­—ä¸² (JPEG, å“è³ª 0.8)
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    state.tempGiftImageBase64 = compressedBase64;
                    renderApp();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // --- æ•¸æ“šè™•ç†ï¼šè¨ˆç®—æ’å (ä¿®æ­£ç‚ºå›å‚³æ‰€æœ‰é …ç›®) ---
        const calculateRanking = () => {
            if (state.gifts.length === 0) {
                return [];
            }

            const voteCounts = {};
            
            // ä¿®æ­£ï¼šä½¿ç”¨ .forEach è¿­ä»£ giftsï¼Œä¸¦ç¢ºä¿ gift è®Šæ•¸çš„ç¯„åœ
            const results = state.gifts.map((gift) => {
                const giftId = gift.id;
                let votes = 0;
                Object.values(state.votes).forEach(voteArray => {
                    if (Array.isArray(voteArray) && voteArray.includes(giftId)) {
                        votes++;
                    }
                });
                return {
                    ...gift,
                    votes: votes,
                };
            });


            // ä¾ç¥¨æ•¸é™åºæ’åˆ—
            results.sort((a, b) => b.votes - a.votes);

            return results; // **å›å‚³æ‰€æœ‰çµæœ**
        };

        // --- NEW: æ•¸å­—æŠ½å–åŠŸèƒ½ ---
        const handleNumberDraw = () => {
            // ä½¿ç”¨ç¸½åƒåŠ äººæ•¸ä½œç‚ºç¯„åœä¸Šé™
            const min = 1;
            const max = state.totalParticipants;
            const count = state.totalParticipants;

            if (max === 0) {
                 state.message = 'è«‹å…ˆåœ¨å–è™Ÿæ©Ÿé é¢è¨­å®šåƒåŠ äººæ•¸ï¼';
                 state.drawResults = [];
                 renderApp();
                 return;
            }

            const range = [];
            for (let i = min; i <= max; i++) {
                range.push(i);
            }

            // Fisher-Yates shuffle ç®—æ³•å¯¦ç¾éš¨æ©Ÿæ’åº
            for (let i = range.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [range[i], range[j]] = [range[j], range[i]];
            }

            state.drawResults = range; // çµæœå·²ç¶“æ˜¯éš¨æ©Ÿæ’åºçš„å®Œæ•´åˆ—è¡¨
            state.message = `ğŸ‰ æˆåŠŸæŠ½å– ${range.length} å€‹è™Ÿç¢¼çš„æ‹†ç¦®ç‰©é †åºï¼`;
            renderApp();
        };

        // --- UI æ¸²æŸ“åŠŸèƒ½ ---

        const renderMessage = () => {
            if (!state.message) return '';
            const msg = state.message;
            setTimeout(() => {
                const box = document.getElementById('message-box');
                if (box) box.style.opacity = '0';
            }, 3000); 

            return `
                <div id="message-box" style="opacity: 1;" class="fixed top-4 left-1/2 transform -translate-x-1/2 p-3 bg-red-600 text-white font-bold rounded-lg shadow-xl z-50 transition-opacity duration-300">
                    ${msg}
                </div>
            `;
        };
        
        // --- NEW: å‚™è¨»å§“åè·³çª— Modal ---
        const renderRemarkModal = () => {
            if (!state.isRemarkModalOpen || state.currentRemarkNumber === null) return '';

            const number = state.currentRemarkNumber;
            const currentName = state.participantNames[number] || '';

            return `
                <div class="modal-overlay">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
                        <h3 class="text-2xl font-extrabold text-blue-700 text-center">
                            å‚™è¨»è™Ÿç¢¼ ${number} çš„å®¶äºº
                        </h3>
                        <p class="text-center text-sm text-gray-600">
                            æ­¤è™Ÿç¢¼å°‡åœ¨æŠ•ç¥¨å€é¡¯ç¤ºå‚™è¨»åç¨±ï¼Œè¼”åŠ©è¨˜æ†¶ã€‚
                        </p>
                        <input type="text" id="remark-name-input" 
                               value="${currentName}" 
                               placeholder="è¼¸å…¥å®¶äººåå­— (æœ€å¤š ${state.MAX_NAME_LENGTH} å­—)" 
                               maxlength="${state.MAX_NAME_LENGTH}"
                               class="w-full p-3 border-2 border-blue-300 rounded-lg text-lg text-center font-bold focus:ring-blue-500">
                        
                        <div class="flex justify-between space-x-3 mt-4">
                            <button onclick="window.handleAdminAction('update-participant-name')"
                                    class="flex-1 py-2 bg-red-600 text-white font-bold rounded-full hover:bg-red-700 transition">
                                å„²å­˜å‚™è¨»
                            </button>
                            <button onclick="window.handleCloseRemarkModal()"
                                    class="flex-1 py-2 bg-gray-200 text-gray-700 font-bold rounded-full hover:bg-gray-300 transition">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- NEW: é–‹å§‹ç•«é¢ Panel ---
        const renderIntroPanel = () => {
            return `
                <div class="space-y-8 p-8 text-center bg-white rounded-xl shadow-2xl border-4 border-blue-700">
                    <h3 class="text-3xl font-extrabold text-blue-700">${state.introHeading}</h3>
                    <p class="text-xl text-gray-700">${state.introSubtext}</p>
                    
                    <!-- è¦å‰‡èˆ‡æµç¨‹æŒ‰éˆ• (Modal Trigger) -->
                    <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <button onclick="window.openFlowModal()"
                                class="py-2 px-6 bg-gray-200 text-blue-600 font-bold rounded-full hover:bg-gray-300 transition">
                            ğŸ“ æŸ¥çœ‹æ´»å‹•æµç¨‹
                        </button>
                        <button onclick="window.openRulesModal()"
                                class="py-2 px-6 bg-gray-200 text-red-600 font-bold rounded-full hover:bg-gray-300 transition">
                            ğŸ“œ æŸ¥çœ‹è¦å‰‡èˆ‡æé†’
                        </button>
                    </div>


                    <div class="space-y-4 pt-4">
                        <button onclick="window.setPage('draw')" class="w-full sm:w-1/2 py-3 bg-red-600 text-white font-bold text-lg rounded-full hover:bg-red-700 transition transform hover:scale-105">
                            ğŸ¾ é–‹å§‹å–è™Ÿ
                        </button>
                    </div>
                </div>
            `;
        };
        
        // --- NEW: å–è™Ÿæ©Ÿ Panel ---
        const renderDrawPanel = () => {
            // ä¿®æ­£å–è™Ÿæ©Ÿçµæœæ¸²æŸ“ï¼šåªé¡¯ç¤ºè—è‰²æ–¹å¡Šå’Œç´…è‰²é †åºæ¨™ç±¤
            const resultsHtml = state.drawResults.map((num, index) => {
                const numStr = String(num);
                const name = state.participantNames[numStr] || '';
                const nameDisplay = name ? `<p class="text-xs font-semibold mt-1 text-yellow-300 truncate">${name}</p>` : '';
                return `
                    <div onclick="window.handleOpenRemarkModal('${numStr}')" class="draw-result-item cursor-pointer hover:shadow-xl hover:ring-2 ring-yellow-300">
                        <!-- ç´…è‰²é †åºåœ“è§’ -->
                        <div class="draw-sequence-tag">
                            ${index + 1}
                        </div>
                        <!-- è—è‰²è™Ÿç¢¼æ–¹å¡Šå…§å®¹ (æ–°å¢ nameDisplay) -->
                        <div class="flex flex-col items-center">
                            <span class="text-3xl font-black">${numStr}</span>
                            ${nameDisplay}
                        </div>
                    </div>
                `;
            }).join('');

            const participantsStatus = state.totalParticipants > 0 
                ? `<p class="font-bold text-lg text-blue-700">ç•¶å‰åƒåŠ äººæ•¸ï¼š${state.totalParticipants} äºº</p>`
                : `<p class="font-bold text-lg text-red-600">âš ï¸ è«‹å…ˆè¨­å®šåƒåŠ äººæ•¸ï¼</p>`;

            const setParticipantsUI = state.totalParticipants === 0 ? `
                <div class="border p-4 rounded-lg bg-blue-100 space-y-3">
                    <h4 class="font-semibold text-blue-700 mb-2 border-b pb-2">è¨­å®šåƒåŠ äººæ•¸</h4>
                    <p class="text-sm text-gray-700">è«‹è¼¸å…¥åƒåŠ ç¸½äººæ•¸ä»¥é–‹å§‹æŠ½è™Ÿã€‚</p>
                    <input type="number" id="participant-count" placeholder="è¼¸å…¥ç¸½äººæ•¸ (ä¾‹å¦‚: 10)" value="" min="1" class="w-full p-2 border border-blue-300 rounded-md">
                    <button onclick="window.handleAdminAction('set-participants')" class="w-full bg-blue-700 text-white font-bold py-2 rounded-full hover:bg-blue-800 transition">
                        ç¢ºå®šè¨­å®šåƒåŠ äººæ•¸
                    </button>
                </div>
            ` : `
                <div class="border p-4 rounded-lg bg-green-100 space-y-3">
                    <p class="text-lg font-bold text-green-700">âœ… åƒåŠ äººæ•¸å·²è¨­å®šç‚º ${state.totalParticipants} äººã€‚</p>
                    <p class="text-sm text-gray-700">å¦‚éœ€ä¿®æ”¹äººæ•¸ï¼Œè«‹å‰å¾€ç®¡ç†å“¡ä»‹é¢ä½¿ç”¨é«˜é¢¨éšªæ“ä½œã€‚</p>
                </div>
            `;

            return `
                <div class="space-y-6 p-4">
                    <h3 class="text-2xl font-extrabold text-blue-700 border-b-2 border-red-600 pb-3">ğŸ”¢ æ‹†ç¦®ç‰©é †åºæŠ½å–æ©Ÿ</h3>

                    <!-- åƒåŠ äººæ•¸è¨­å®šå€ (åªæœ‰åœ¨äººæ•¸æœªè¨­å®šæ™‚æ‰é¡¯ç¤ºè¼¸å…¥æ¡†) -->
                    ${setParticipantsUI}


                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 space-y-4">
                        
                        <p class="text-gray-600">æŒ‰ä¸‹æŒ‰éˆ•å¾Œï¼Œå°‡éš¨æ©Ÿç”¢ç”Ÿå¾ 1 åˆ° ${state.totalParticipants} è™Ÿçš„æ‹†ç¦®ç‰©é †åºåˆ—è¡¨ã€‚</p>

                        <button onclick="window.handleNumberDraw()" 
                                ${state.totalParticipants === 0 ? 'disabled' : ''}
                                class="w-full py-3 bg-red-600 text-white font-bold text-lg rounded-xl hover:bg-red-700 transition disabled:bg-gray-400">
                            ğŸ° ç”¢ç”Ÿéš¨æ©Ÿæ‹†ç¦®ç‰©é †åº (å…± ${state.totalParticipants} å€‹è™Ÿç¢¼)
                        </button>
                        <p class="text-xs text-gray-500 pt-2 border-t mt-4">
                            ğŸ’¡ **æç¤º:** é»æ“Šè—è‰²è™Ÿç¢¼æ–¹å¡Šå³å¯å‚™è¨»è©²è™Ÿç¢¼å°æ‡‰çš„å®¶äººåå­—ã€‚
                        </p>
                    </div>
                    
                    ${state.drawResults.length > 0 ? `
                        <h3 class="text-xl font-bold text-blue-700 pt-4 border-t">âœ… æ‹†ç¦®ç‰©é †åºåˆ—è¡¨ (æ‹†ç¦®ç‰©é †åº 1 â†’ ${state.drawResults.length})</h3>
                        <!-- ç§»é™¤ max-h å’Œ overflow-y-auto è®“å…§å®¹è‡ªç”±å»¶ä¼¸ -->
                        <div class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-4 bg-gray-50 p-4 rounded-xl border">
                            ${resultsHtml}
                        </div>
                    ` : ''}
                    
                    <div class="text-center pt-4 border-t">
                        <button onclick="window.setPage('vote')" class="w-full sm:w-1/2 py-2 bg-blue-700 text-white font-bold rounded-full hover:bg-blue-800 transition">
                            ç¹¼çºŒå‰å¾€æŠ•ç¥¨å€
                        </button>
                    </div>
                </div>
            `;
        };
        
        // --- æŠ•ç¥¨ä»£è™ŸæŒ‰éˆ•å€ ---
        const renderVoterButtons = () => {
            if (state.totalParticipants === 0) {
                return `
                    <div class="p-4 rounded-xl border-2 bg-yellow-100 border-yellow-600 text-yellow-700 mb-6 text-center">
                        <p class="font-semibold">âš ï¸ å°šæœªè¨­å®šåƒåŠ äººæ•¸ï¼Œè«‹ç®¡ç†å“¡å…ˆè¨­å®šäººæ•¸ã€‚</p>
                    </div>
                `;
            }

            const buttons = [];
            for (let i = 1; i <= state.totalParticipants; i++) {
                const id = String(i);
                const hasVoted = state.votes[id] && Array.isArray(state.votes[id]) && state.votes[id].length > 0;
                const isSelected = state.voterId === id;
                const nameRemark = state.participantNames[id]; // <-- NEW: å–å¾—å‚™è¨»åç¨±

                let buttonClass = 'bg-gray-200 text-gray-700 hover:bg-gray-300';
                let buttonText = id;

                if (hasVoted) {
                    buttonClass = 'bg-red-600 text-white cursor-not-allowed opacity-50';
                    buttonText = `${id}`;
                } else if (isSelected) {
                    // ç•¶å‰é¸å®š - è–èª•ç¶  (è·¨å¹´ä¸»é¡Œ: è—è‰²)
                    buttonClass = 'bg-blue-600 text-white shadow-lg ring-2 ring-blue-300';
                    buttonText = `${id}`;
                } else {
                    // å¯é¸çš„æŒ‰éˆ•
                    buttonClass += ' hover:bg-red-50';
                }

                buttons.push(`
                    <button onclick="window.selectVoterId('${id}')"
                            ${hasVoted ? 'disabled' : ''}
                            class="p-3 rounded-xl font-bold transition duration-200 text-sm transform hover:scale-105 ${buttonClass} flex flex-col justify-center items-center">
                        <span class="text-lg font-extrabold leading-none">${id}</span>
                        ${nameRemark ? `<span class="text-xs font-normal opacity-90 leading-tight mt-0.5" style="color: inherit; filter: brightness(120%);">${nameRemark}</span>` : ''}
                    </button>
                `);
            }

            // ç‹€æ…‹é¡¯ç¤º
            let statusClass = 'bg-yellow-100 border-yellow-600 text-yellow-700'; // é»ƒè‰²æé†’
            let statusText = 'è«‹å…ˆé¸æ“‡æ‚¨çš„æŠ•ç¥¨ä»£è™Ÿã€‚';

            if (state.voterStatus === 'can_vote') {
                statusClass = 'bg-green-100 border-green-600 text-green-700';
                statusText = `âœ… ä»£è™Ÿï¼š${state.voterId}ã€‚è«‹åœ¨ä¸‹æ–¹é»æ“Šç¦®ç‰©åœ–ç‰‡ï¼Œé¸å‡º 1-${MAX_VOTES} ç¥¨ã€‚`;
            } else if (state.voterStatus === 'has_voted') {
                statusClass = 'bg-red-100 border-red-600 text-red-700';
                statusText = `âŒ ä»£è™Ÿ ${state.voterId} å·²æäº¤éæŠ•ç¥¨ã€‚è«‹é¸æ“‡ä¸‹ä¸€å€‹ä»£è™Ÿã€‚`;
            }

            return `
                <div class="space-y-4">
                    <div class="p-4 rounded-xl border-2 ${statusClass}">
                        <p class="font-semibold">${statusText}</p>
                        ${state.voterStatus === 'has_voted' ? 
                            '<button onclick="window.handleVoterSwitch()" class="mt-2 px-3 py-1 bg-red-600 text-white text-sm font-bold rounded-lg hover:bg-red-700 transition">é»æ­¤åˆ‡æ›ä¸‹ä¸€ä½æŠ•ç¥¨è€…</button>' : ''
                        }
                    </div>
                    
                    <h3 class="font-bold text-gray-700 mb-2">è«‹é¸æ“‡æ‚¨çš„æŠ•ç¥¨ä»£è™Ÿ (åƒåŠ è€…ç·¨è™Ÿ 1 åˆ° ${state.totalParticipants})ï¼š</h3>
                    <div class="grid grid-cols-5 md:grid-cols-7 lg:grid-cols-10 gap-3 p-4 bg-gray-50 rounded-lg border">
                        ${buttons.join('')}
                    </div>
                </div>
            `;
        };

        // ** æŠ•ç¥¨å€æ¸²æŸ“å‡½æ•¸ - Grid ä½ˆå±€ **
        const renderGiftsList = (gifts) => {
            if (gifts.length === 0) {
                return '<p class="text-center text-gray-500 p-8">ğŸ ç¦®ç‰©æ¸…å–®ç‚ºç©ºï¼Œè«‹ç®¡ç†å“¡æ–°å¢ç¦®ç‰©ï¼</p>';
            }

            const hasSubmitted = state.currentUserVotes.length > 0;
            const allowInteraction = state.voterStatus === 'can_vote'; 
            
            // NEW: è¨ˆç®—ç¸½æŠ•ç¥¨å®Œæˆç‹€æ…‹
            const submittedVoterCount = Object.keys(state.votes).filter(key => Array.isArray(state.votes[key]) && key !== '0' && state.votes[key].length > 0).length;
            const isVotingComplete = state.totalParticipants > 0 && submittedVoterCount >= state.totalParticipants;


            const giftCards = gifts.map((gift) => {
                const isSelected = allowInteraction && tempSelections.includes(gift.id); 
                const isSubmittedVoted = hasSubmitted && state.currentUserVotes.includes(gift.id);

                let buttonText;
                let voteBtnClass;
                let clickAction = '';
                
                if (hasSubmitted) {
                    buttonText = isSubmittedVoted ? 'å·²æŠ• (é–å®š)' : 'æœªæŠ•';
                    voteBtnClass = isSubmittedVoted ? 'btn-submitted btn-disabled' : 'bg-gray-400 text-white cursor-default';
                } else if (allowInteraction) {
                    buttonText = isSelected ? 'å–æ¶ˆé¸æ“‡' : (tempSelections.length >= MAX_VOTES ? 'å·²æ»¿é¡' : 'é¸æ“‡');
                    voteBtnClass = isSelected ? 'btn-active-selection' : (tempSelections.length >= MAX_VOTES && !isSelected ? 'btn-disabled' : 'btn-vote');
                    clickAction = `window.handleSelection('${gift.id}')`;
                } else {
                    buttonText = 'è«‹å…ˆé¸æ“‡ä»£è™Ÿ';
                    voteBtnClass = 'btn-disabled';
                }


                const imageSrc = gift.image || `https://placehold.co/150x200/1e40af/fbbf24?text=GIFT`; 

                return `
                    <div onclick="${clickAction}"
                        class="card bg-white p-3 rounded-xl flex flex-col items-center justify-between border border-gray-200 
                        ${isSubmittedVoted ? 'border-4 border-blue-700 ring-2 ring-blue-300' : (!allowInteraction || hasSubmitted ? 'opacity-50 cursor-default' : 'hover:border-blue-600')} transition duration-200">
                        
                        <div class="w-full text-center mb-3">
                            <!-- 3:4 æ¯”ä¾‹å®¹å™¨ (ç›´å‘) -->
                            <div class="relative w-full aspect-[3/4] mb-3 rounded-lg overflow-hidden shadow-md">
                                <img src="${imageSrc}" alt="Gift Image" class="absolute inset-0 gift-image-thumb w-full h-full object-cover">
                            </div>
                            <div class="text-sm">
                                <h3 class="font-extrabold text-lg text-gray-800 truncate">${gift.description}</h3>
                            </div>
                        </div>
                        <button disabled
                                class="w-full px-2 py-2 rounded-full font-bold text-xs shadow-md ${voteBtnClass}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');

            // æäº¤æŒ‰éˆ•å€åŸŸ
            let submitButton = '';

            if (isVotingComplete) {
                // å¦‚æœæŠ•ç¥¨å®Œæˆï¼Œå‰‡é¡¯ç¤ºæœ€çµ‚å¼•å°æŒ‰éˆ• (ç„¡è«–ç•¶å‰ä»£è™Ÿæ˜¯å¦å·²æŠ•)
                submitButton = `
                    <div class="mt-8 text-center p-4 bg-yellow-100 border-2 border-yellow-600 rounded-xl">
                        <p class="text-xl font-extrabold text-yellow-700">ğŸ—³ï¸ æŠ•ç¥¨ç’°ç¯€å·²å®Œæˆï¼</p>
                        <p class="text-sm text-gray-600 mt-2">æ‰€æœ‰åƒåŠ è€…éƒ½å·²æŠ•å®Œç¥¨ï¼Œå¯ä»¥å‰å¾€æ­éœ²é€ç¦®è€…ã€‚</p>
                    </div>
                    <div class="text-center pt-4 border-t">
                        <button onclick="window.setPage('reveal')" class="w-full sm:w-1/2 py-2 bg-blue-700 text-white font-bold rounded-full hover:bg-blue-800 transition">
                            ç¹¼çºŒå‰å¾€æ­éœ²é€ç¦®è€…
                        </button>
                    </div>
                `;
            } else if (state.voterStatus === 'has_voted') {
                submitButton = `
                    <div class="mt-8 text-center p-4 bg-blue-100 border-2 border-blue-600 rounded-xl">
                        <p class="text-xl font-extrabold text-blue-700">âœ… ä»£è™Ÿ ${state.voterId} çš„æŠ•ç¥¨å·²é€å‡ºä¸¦é–å®š (${state.currentUserVotes.length} ç¥¨)</p>
                        <p class="text-sm text-gray-600 mt-2">ç­‰å¾…å…¶é¤˜ ${state.totalParticipants - submittedVoterCount} ä½åƒåŠ è€…æŠ•ç¥¨ã€‚</p>
                    </div>
                `;
            } else if (state.voterStatus === 'can_vote') {
                submitButton = `
                    <div class="mt-8 text-center">
                        <p class="text-lg font-semibold text-gray-700 mb-4">ç•¶å‰å·²é¸ç¥¨æ•¸ï¼š<span class="text-red-600 font-extrabold">${tempSelections.length} / ${MAX_VOTES}</span> ç¥¨</p>
                        <button onclick="window.handleSubmitVotes()"
                                ${tempSelections.length === 0 ? 'disabled' : ''}
                                class="w-full max-w-sm text-white text-lg font-bold py-3 rounded-full shadow-lg transition duration-200 btn-submit disabled:bg-gray-400">
                            ğŸ—³ï¸ ç¢ºèªé€å‡º ${tempSelections.length} ç¥¨ (é€å‡ºå¾Œç„¡æ³•æ›´æ”¹)
                        </button>
                    </div>
                `;
            } else {
                 submitButton = `
                    <div class="mt-8 text-center p-4 bg-gray-100 border-2 border-gray-300 rounded-xl">
                        <p class="text-xl font-extrabold text-gray-700">è«‹å…ˆé¸æ“‡æ‚¨çš„æŠ•ç¥¨ä»£è™Ÿ</p>
                    </div>
                `;
            }

            return `
                ${renderVoterButtons()}
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 sm:gap-6 mt-6">
                    ${giftCards}
                </div>
                ${submitButton}
            `;
        };

        // --- UI æ¸²æŸ“åŠŸèƒ½ï¼šçµæœæ’å (é‡é»é¡¯ç¤ºå‰ä¸‰ååœ–å¡) ---
        const renderRanking = (fullResults) => {
            if (!state.isRankingPublic) {
                return `
                    <div class="flex flex-col items-center justify-center h-96 p-8 bg-gray-100 rounded-xl border-2 border-gray-300">
                        <svg class="w-16 h-16 text-blue-700 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        <h3 class="text-2xl font-bold text-gray-700 mb-2">æ’è¡Œæ¦œå°šæœªå…¬é–‹</h3>
                        <p class="text-lg text-gray-500">è«‹ç­‰å¾…ç®¡ç†å“¡åœ¨å¾Œå°é»æ“Šã€Œå…¬å¸ƒã€æŒ‰éˆ•ã€‚</p>
                    </div>
                `;
            }
            
            const isRevealing = state.revealCountdown > 0;
            if (isRevealing) {
                return `
                    <div id="confetti-container" class="relative flex flex-col items-center justify-center h-96 p-8 bg-gradient-to-br from-red-500 to-yellow-500 rounded-xl border-4 border-white reveal-countdown-box">
                        <h3 class="text-3xl font-extrabold text-white mb-8">å€’æ•¸è¨ˆæ™‚ï¼</h3>
                        <p class="text-8xl font-black text-white reveal-countdown-text">${state.revealCountdown}</p>
                        <p class="text-xl font-bold text-yellow-300 mt-6">æº–å‚™è¿æ¥ä»Šå¹´çš„æ¦®è€€å¾—ä¸»ï¼</p>
                    </div>
                `;
            }
            
            if (state.gifts.length === 0 || Object.keys(state.votes).length === 0) {
                return '<p class="text-center text-gray-500 p-8">ğŸ—³ï¸ æš«ç„¡æŠ•ç¥¨æ•¸æ“šï¼Œè«‹å¤§å®¶è¸´èºæŠ•ç¥¨ï¼</p>';
            }


            const honorRanksCount = Math.min(state.honorRanks, fullResults.length); 
            
            const getRankStyles = (rankIndex) => {
                switch (rankIndex) {
                    case 0: 
                        return { title: `ğŸ¾ å† è»`, icon: 'ğŸ‘‘', bg: 'bg-yellow-50', border: 'border-yellow-600', text: 'text-red-600' };
                    case 1: 
                        return { title: 'ğŸ¥ˆ äºè»', icon: 'ğŸ¥ˆ', bg: 'bg-gray-100', border: 'border-gray-500', text: 'text-blue-700' };
                    case 2: 
                        return { title: 'ğŸ¥‰ å­£è»', icon: 'ğŸ¥‰', bg: 'bg-amber-100', border: 'border-amber-500', text: 'text-red-500' };
                    default:
                        return { title: '', icon: `ç¬¬ ${rankIndex + 1} å`, bg: 'bg-white', border: 'border-gray-200', text: 'text-gray-800' };
                }
            };
            
            // --- 1. æ¸²æŸ“æ¦®è€€åœ–å¡ ---
            const topRanks = fullResults.slice(0, honorRanksCount);
            const otherRanks = fullResults.slice(honorRanksCount);

            const topCards = topRanks.map((result, index) => {
                const styles = getRankStyles(index);
                const imageSrc = result.image || `https://placehold.co/80x107/1e40af/fbbf24?text=GIFT`; 
                const imageContainerClass = 'w-1/2 max-w-[150px] mx-auto'; 
                
                const isGiverAnnounced = result.giver && result.giver.trim() !== '';
                const giverName = isGiverAnnounced
                    ? `<span class="text-blue-700 font-bold">${result.giver}</span>` 
                    : `<span class="text-gray-400 text-sm">å°šæœªå…¬å¸ƒ</span>`;
                const giverLabel = isGiverAnnounced ? 'é€ç¦®è€…:' : '';

                return `
                    <div class="ranking-card-top ${styles.bg} ${styles.border} p-5 rounded-xl text-center flex flex-col items-center justify-between h-full">
                        <div class="text-4xl mb-2">${styles.icon}</div>
                        <h4 class="text-xl font-extrabold ${styles.text} mb-2">${styles.title}</h4>
                        <div class="${imageContainerClass} relative aspect-[3/4] mb-3 rounded-lg overflow-hidden shadow-lg">
                            <img src="${result.image || imageSrc}" alt="Gift Image" class="absolute inset-0 w-full h-full object-cover">
                        </div>
                        <p class="text-3xl font-black text-red-600 mb-1">${result.votes} ç¥¨</p>
                        <p class="text-lg font-semibold text-gray-800 mt-2">${giverLabel} ${giverName}</p>
                        <p class="text-sm text-gray-600 truncate px-2">${result.description}</p>
                        <p class="text-xs font-bold mt-2 text-red-600">çé …: ${state.prizeDescription}</p>
                    </div>
                `;
            }).join('');
            
            // --- 2. æ¸²æŸ“å…¶ä»–åæ¬¡åˆ—è¡¨ ---
            const otherList = otherRanks.map((result, index) => {
                const rankIndex = index + honorRanksCount;
                const imageSrc = result.image || `https://placehold.co/50x50/1e40af/fbbf24?text=G`;
                const giverName = result.giver && result.giver.trim() !== '' 
                    ? result.giver 
                    : `å°šæœªå…¬å¸ƒ`;
                const giverClass = result.giver && result.giver.trim() !== '' ? 'text-gray-800' : 'text-gray-400';


                return `
                    <div class="bg-white p-3 rounded-xl mb-2 border border-gray-200 flex items-center justify-between">
                        <div class="flex items-center space-x-3 w-3/4">
                            <div class="w-10 h-10 flex-shrink-0 relative">
                                <img src="${imageSrc}" alt="Gift Image" class="gift-image-preview w-full h-full rounded-md shadow-sm">
                            </div>
                            <div class="flex flex-col min-w-0">
                                <p class="text-sm font-bold text-gray-800 truncate">
                                    ç¬¬ ${rankIndex + 1} å - é€ç¦®è€…: <span class="${giverClass}">${giverName}</span>
                                </p>
                                <p class="text-xs text-gray-500 truncate">${result.description}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-xl font-black text-gray-700">
                                ${result.votes} ç¥¨
                            </p>
                        </div>
                    </div>
                `;
            }).join('');


            return `
                <div class="space-y-6">
                    <h3 class="text-2xl font-extrabold text-blue-700 border-b-2 border-red-600 pb-3 mb-6 text-center">ğŸ‰ æ’è¡Œæ¦œ ğŸ‰</h3>
                    
                    <h3 class="text-xl font-bold text-red-600">ğŸ¥‚ **æ¦®è€€å¾—ä¸» (${honorRanksCount} å)**</h3>
                    <!-- Top Ranks Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-${honorRanksCount} gap-6">
                        ${topCards.length > 0 ? topCards : '<p class="text-center text-gray-500">ç®¡ç†å“¡è¨­å®šç‚º 0 å€‹æ¦®è€€çé …ã€‚</p>'}
                    </div>
                    
                    ${otherRanks.length > 0 ? `
                        <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mt-8">å…¶é¤˜ç¦®ç‰©åæ¬¡ (ç¬¬ ${honorRanksCount + 1} åä¹‹å¾Œ)</h3>
                        <!-- Other Ranks List -->
                        <div class="space-y-3">
                            ${otherList}
                        </div>
                    ` : ''}
                </div>
            `;
        };
        
        // --- NEW: è¦å‰‡è·³çª— Modal ---
        const renderRulesModal = () => {
            if (!state.isRulesModalOpen) return '';

            // è¦å‰‡å…§å®¹ç”¨ pre-wrap ä¿æŒæ ¼å¼
            const formattedContent = state.rulesContent.replace(/\n/g, '\n');

            return `
                <div class="modal-overlay">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-2xl font-extrabold text-blue-700">${state.rulesHeading}</h3>
                            <button onclick="window.closeRulesModal()" class="text-gray-500 hover:text-red-600 font-bold text-2xl leading-none">
                                &times;
                            </button>
                        </div>
                        <pre class="text-left text-base text-gray-700 whitespace-pre-wrap font-sans leading-relaxed">${formattedContent}</pre>
                        <div class="mt-6 text-center">
                            <button onclick="window.closeRulesModal()" class="px-6 py-2 bg-red-600 text-white font-bold rounded-full hover:bg-red-700 transition">
                                ç­è§£äº†ï¼Œé–‹å§‹éŠæˆ²
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // NEW: æµç¨‹è·³çª— Modal ---
        const renderFlowModal = () => {
            if (!state.isFlowModalOpen) return '';

            // NEW: å°‡å…§å®¹æŒ‰è¡Œåˆ†å‰²ï¼Œä¸¦æ ¼å¼åŒ–ç‚ºæœ‰åºåˆ—è¡¨ (Numbered List)
            const flowSteps = state.flowContent
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => {
                    // ç§»é™¤ä»»ä½•é–‹é ­çš„æ•¸å­—å’Œé»è™Ÿï¼Œè®“ CSS è™•ç†ç·¨è™Ÿ
                    const cleanLine = line.replace(/^[0-9.]+\s*/, ''); 
                    return `<li class="text-gray-700">${cleanLine}</li>`;
                })

            // ä½¿ç”¨è‡ªè¨‚çš„ flow-list é¡åˆ¥ä¾†å¯¦ç¾ CSS æ§åˆ¶çš„ç¸®æ’å’Œç²—é«”æ•¸å­—
            const formattedContent = `<ol class="flow-list space-y-2 pt-2">${flowSteps.join('')}</ol>`;

            return `
                <div class="modal-overlay">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-2xl font-extrabold text-red-600">${state.flowHeading}</h3>
                            <button onclick="window.closeFlowModal()" class="text-gray-500 hover:text-red-600 font-bold text-2xl leading-none">
                                &times;
                            </button>
                        </div>
                        <div class="text-left font-sans text-base">
                           ${formattedContent} 
                        </div>
                        <div class="mt-6 text-center">
                            <button onclick="window.closeFlowModal()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition">
                                ç¢ºèªæµç¨‹
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }


        // NEW: æ­éœ²é€ç¦®è€… Panel (å¡ç‰‡ç¶²æ ¼ä½ˆå±€) ---
        const renderRevealPanel = () => {
            
            const submittedVoterCount = Object.keys(state.votes).filter(key => Array.isArray(state.votes[key]) && key !== '0' && state.votes[key].length > 0).length;
            const isVotingComplete = state.totalParticipants > 0 && submittedVoterCount >= state.totalParticipants;
            
            const votingStatusText = state.totalParticipants === 0
                ? 'âš ï¸ è«‹å…ˆåœ¨å–è™Ÿæ©Ÿé é¢è¨­å®šåƒåŠ äººæ•¸ï¼'
                : `ğŸ—³ï¸ ç•¶å‰å·²å®ŒæˆæŠ•ç¥¨äººæ•¸ï¼š${submittedVoterCount} / ${state.totalParticipants} äºº`;

            let listOverlay = '';
            let listClasses = '';
            let listPointerEvents = '';

            // æª¢æŸ¥æŠ•ç¥¨æ˜¯å¦å®Œæˆæˆ–äººæ•¸æ˜¯å¦è¨­å®š
            if (!isVotingComplete) {
                const icon = state.totalParticipants === 0 ? 'âŒ' : 'âš ï¸';
                const heading = state.totalParticipants === 0 ? 'è«‹å…ˆè¨­å®šåƒåŠ äººæ•¸ï¼' : 'å°šæœªæŠ•ç¥¨å®Œæˆï¼';
                const subtext = state.totalParticipants === 0 
                    ? 'è«‹è‡³å–è™Ÿæ©Ÿé é¢è¨­å®šåƒåŠ ç¸½äººæ•¸ã€‚'
                    : 'è«‹å…ˆé€²è¡ŒæŠ•ç¥¨ç’°ç¯€ï¼Œæˆ–ç­‰å¾…æ‰€æœ‰åƒåŠ è€…å®ŒæˆæŠ•ç¥¨ã€‚';

                listOverlay = `
                    <div class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center p-8 rounded-xl z-20">
                        <span class="text-6xl mb-4">${icon}</span>
                        <h3 class="text-2xl font-bold text-red-700 mb-2">${heading}</h3>
                        <p class="text-lg text-gray-600 text-center">${subtext}</p>
                        <p class="text-sm text-gray-500 mt-2">${votingStatusText}</p>
                    </div>
                `;
                listClasses = 'opacity-50'; // åç°æ•ˆæœ
                listPointerEvents = 'pointer-events-none'; // ç¦æ­¢äº’å‹•
            }


            const revealList = state.gifts.map((gift, index) => {
                const imageSrc = gift.image || `https://placehold.co/150x200/1e40af/fbbf24?text=GIFT`;
                const giverInputId = `reveal-input-${gift.id}`;
                const currentGiver = gift.giver && gift.giver.trim() !== '' ? gift.giver : ''; 
                const giverClass = currentGiver ? 'text-red-600 font-extrabold' : 'text-gray-500 font-semibold';
                
                const isGiverSet = currentGiver.length > 0;

                return `
                    <div class="card bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-between border border-gray-200">
                        <!-- 1. ç¦®ç‰©ç·¨è™Ÿ / åœ–ç‰‡ -->
                        <div class="w-full text-center mb-3 relative">
                            <span class="absolute w-6 h-6 bg-blue-700 rounded-full top-[-8px] left-[-8px] flex items-center justify-center text-xs font-bold text-white z-10 shadow-md">
                                #${index + 1}
                            </span>
                            <div class="relative w-full aspect-[3/4] mb-2 rounded-lg overflow-hidden shadow-md">
                                <img src="${imageSrc}" alt="Gift Image" class="absolute inset-0 gift-image-thumb w-full h-full object-cover">
                            </div>
                        </div>

                        <!-- 2. ç¦®ç‰©ç°¡è¿° (æ¸›å°‘é–“è·) -->
                        <div class="w-full text-center">
                            <h3 class="font-extrabold text-lg text-gray-800 truncate leading-tight">${gift.description}</h3>
                        </div>

                        <!-- 3. Giver Status (ä½”ç”¨å›ºå®šé«˜åº¦ä»¥ç©©å®šä½ˆå±€) -->
                        <div class="giver-status-area">
                            <div class="text-center w-full">
                                <p class="text-sm font-bold text-gray-800 leading-none">
                                    é€ç¦®è€…ï¼š
                                    ${currentGiver ? `<span class="text-lg font-extrabold ${giverClass} leading-tight">${currentGiver}</span>` : ''}
                                </p>
                            </div>
                        </div>

                        <!-- 4., 5. Dropdown & Button -->
                        <div class="giver-controls">
                            <div class="space-y-2 w-full">
                                <select id="${giverInputId}"
                                        ${isGiverSet ? 'disabled' : ''}
                                        class="p-1 border border-gray-300 rounded-md text-sm w-full text-center font-semibold 
                                               ${isGiverSet ? 'bg-gray-100 text-gray-500 opacity-80 cursor-not-allowed' : ''}">
                                    <option value="" ${!currentGiver ? 'selected' : ''}>-- é¸æ“‡é€ç¦®è€… --</option>
                                    ${
                                        // ç¢ºä¿ç•¶å‰å‚™è¨»çš„é€ç¦®è€…åå­—è¢«é¸ä¸­
                                        Object.entries(state.participantNames).map(([number, name]) => 
                                            `<option value="${name}" ${currentGiver === name ? 'selected' : ''}>ç·¨è™Ÿ ${number}ï¼š${name}</option>`
                                        ).join('')
                                    }
                                </select>
                                
                                <button onclick="window.handleAdminAction('update-giver', '${gift.id}')"
                                        ${isGiverSet ? 'disabled' : ''}
                                        class="px-3 py-2 text-sm bg-green-600 text-white rounded-full transition w-full 
                                               ${isGiverSet ? 'opacity-60 cursor-not-allowed bg-gray-400 hover:bg-gray-400' : 'hover:bg-green-700'}">
                                    å„²å­˜å‚™è¨»
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');


            return `
                <div class="space-y-6 p-4">
                    <h3 class="text-2xl font-extrabold text-red-600 border-b-2 border-blue-700 pb-3">ğŸ“£ æ­éœ²é€ç¦®è€…ç’°ç¯€</h3>
                    <p class="text-gray-600">è«‹åœ¨æ­¤è™•è¼¸å…¥æ¯å€‹ç¦®ç‰©çš„é€ç¦®è€…ï¼Œå…¬é–‹æ’åé é¢å°‡åŒæ­¥æ›´æ–°ã€‚</p>
                    
                    <!-- æŠ•ç¥¨é€²åº¦æç¤º -->
                    <p class="text-center text-sm font-semibold text-gray-700 p-2 ${isVotingComplete ? 'bg-green-100' : 'bg-yellow-100'} rounded-lg">
                        ${votingStatusText}
                    </p>

                    <!-- å¡ç‰‡ç¶²æ ¼ä½ˆå±€ (æœ‰é–å®šç–Šå±¤) -->
                    <div class="relative p-4 rounded-xl border border-gray-200 min-h-[250px] flex items-center justify-center">
                        ${listOverlay}
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 ${listClasses} ${state.gifts.length === 0 ? 'w-full' : ''}" style="${listPointerEvents}">
                            ${revealList.length > 0 ? revealList : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl lg:col-span-5 w-full">ğŸ ç¦®ç‰©æ¸…å–®ç‚ºç©ºï¼Œè«‹ç®¡ç†å“¡æ–°å¢ç¦®ç‰©ï¼</p>'}
                        </div>
                    </div>


                    <!-- æ’è¡Œæ¦œå…¬å¸ƒå€å¡Š (ç„¡å¯†ç¢¼é–å®š) -->
                    <div class="border p-4 rounded-lg ${state.isRankingPublic ? 'bg-red-100 border-red-600' : 'bg-green-100 border-green-600'} space-y-3 text-center mt-8">
                        <h3 class="text-xl font-bold ${state.isRankingPublic ? 'text-red-700' : 'text-green-700'}">æœ€çµ‚æ’è¡Œæ¦œå…¬å¸ƒ</h3>
                        ${state.isRankingPublic ? `
                            <p class="text-gray-700">æ’è¡Œæ¦œå·²å…¬é–‹ã€‚é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¯æ’¤éŠ·ã€‚</p>
                            <button onclick="window.handleAdminAction('unpublish-ranking')" class="w-full bg-red-600 text-white font-bold py-2 rounded-full hover:bg-red-700 transition">
                                æ’¤éŠ·å…¬å¸ƒ
                            </button>
                        ` : `
                            <p class="text-gray-700">ç•¶æ‰€æœ‰é€ç¦®è€…éƒ½æ­éœ²å¾Œï¼Œé»æ“Šæ­¤è™•å…¬å¸ƒæœ€çµ‚çµæœã€‚</p>
                            <button onclick="window.handleAdminAction('publish-ranking')" 
                                    ${!isVotingComplete ? 'disabled' : ''}
                                    class="w-full bg-green-600 text-white font-bold py-2 rounded-full hover:bg-green-700 transition disabled:bg-gray-400">
                                ç«‹å³å…¬å¸ƒæ’å (é–‹å§‹ 5 ç§’å€’æ•¸)
                            </button>
                        `}
                    </div>
                </div>
            `;
        };
        
        // --- ç®¡ç†å“¡é é¢æ¸²æŸ“ (åŒ…å«æœƒè©±é–å®šå’Œå…©æ¬„ä½ˆå±€) ---
        const renderAdminPanel = () => {
            const previewSrc = state.tempGiftImageBase64 || `https://placehold.co/80x80/cccccc/333333?text=é è¦½`;
            
            // æª¢æŸ¥é–å®šç‹€æ…‹
            const isLocked = Date.now() >= adminUnlockedUntil;
            state.isAdminLocked = isLocked;
            const unlockTimeLeft = Math.max(0, adminUnlockedUntil - Date.now()); // å‰©é¤˜æ¯«ç§’æ•¸

            let lockMessage = isLocked 
                ? 'è«‹è¼¸å…¥å¯†ç¢¼ä»¥è§£é–ç®¡ç†å“¡åŠŸèƒ½'
                : `ğŸ”’ å·²è§£é–ã€‚å‰©é¤˜æ™‚é–“: ${formatTimeRemaining(unlockTimeLeft)}`;
                
            let lockClass = isLocked ? 'bg-red-100 border-red-600' : 'bg-green-100 border-green-600';
            
            // ç”Ÿæˆé€ç¦®è€…å‚™è¨»æ¸…å–® (åƒ…ä¾›ç®¡ç†å“¡æŸ¥é–±)
            const uploadedGiftsList = state.gifts.map((gift, index) => {
                const imageSrc = gift.image || `https://placehold.co/40x40/1e40af/fbbf24?text=G`;
                const giverStatus = gift.giver && gift.giver.trim() !== '' ? `å·²å‚™è¨»: ${gift.giver}` : 'å°šæœªå…¬å¸ƒ';
                const giverClass = gift.giver && gift.giver.trim() !== '' ? 'text-green-700' : 'text-red-500';

                return `
                    <div class="flex items-center space-x-3 py-2 border-b border-gray-200 last:border-b-0">
                        <div class="w-10 h-10 flex-shrink-0 relative">
                            <img src="${imageSrc}" alt="Gift Image" class="admin-thumb w-full h-full rounded-md shadow-sm">
                        </div>
                        <div class="flex flex-col flex-grow min-w-0">
                            <span class="text-xs text-gray-500 font-semibold">ç¦®ç‰© #${index + 1}</span>
                            <span class="text-sm font-bold text-gray-800 truncate">${gift.description}</span>
                        </div>
                        <span class="text-xs font-semibold ${giverClass} flex-shrink-0 w-28 text-right">${giverStatus}</span>
                        <button onclick="window.handleAdminAction('clear-giver', '${gift.id}')" 
                            class="px-2 py-1 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 transition"
                            ${isLocked ? 'disabled' : ''}>
                            æ¸…é™¤å‚™è¨»
                        </button>
                    </div>
                `;
            }).join('');


            return `
                <div class="p-6 bg-gray-50 rounded-xl space-y-6">
                    <h3 class="text-xl font-bold text-red-600">âš ï¸ ç®¡ç†å“¡æ“ä½œå€</h3>
                    
                    <!-- 1. æ»¿ç‰ˆå¯†ç¢¼è¼¸å…¥/ç‹€æ…‹å€ (æœƒè©±é–) -->
                    <div class="p-4 rounded-xl border-2 ${lockClass}">
                        <p class="font-semibold text-gray-700 mb-2">${lockMessage}</p>
                        ${isLocked ? `
                            <div class="flex space-x-2">
                                <input type="password" id="admin-password" placeholder="ç®¡ç†å¯†ç¢¼" class="w-full p-2 border border-red-300 rounded-md focus:ring-red-500 focus:border-red-500">
                                <button onclick="window.handleAdminLockCheck()" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition">
                                    è§£é–
                                </button>
                            </div>
                        ` : `
                            <div class="flex justify-between items-center">
                                <p class="text-sm text-green-700">æ‚¨ç›®å‰æ“æœ‰ 10 åˆ†é˜çš„ç®¡ç†å“¡æ¬Šé™ã€‚</p>
                                <button onclick="window.handleAdminAction('manual-lock')" class="px-3 py-1 bg-gray-500 text-white text-xs rounded-full hover:bg-gray-600 transition">
                                    ç«‹å³é–å®šç·¨è¼¯
                                </button>
                            </div>
                        `}
                    </div>
                    
                    
                    <!-- 2. æ‡‰ç”¨ç¨‹å¼é…ç½® (æ»¿ç‰ˆï¼Œå¯æ”¶æŠ˜) -->
                    <div class="border p-0 rounded-lg bg-yellow-100">
                        <button onclick="window.toggleConfig()" 
                                class="w-full p-4 flex justify-between items-center font-bold text-red-600 bg-yellow-200 hover:bg-yellow-300 transition rounded-t-lg">
                            <span>âš™ï¸ æ‡‰ç”¨ç¨‹å¼é…ç½®èˆ‡è¨­å®š (A/B)</span>
                            <span>${state.isConfigOpen ? 'â–² éš±è—' : 'â–¼ å±•é–‹'}</span>
                        </button>
                        <div class="collapsible-content ${state.isConfigOpen ? 'max-h-full opacity-100 p-4' : 'max-h-0 opacity-0'}" style="max-height: ${state.isConfigOpen ? '1400px' : '0px'};">
                            
                            <!-- é…ç½®èˆ‡äººæ•¸è¨­å®š - æ»¿ç‰ˆå…§éƒ¨ä½ˆå±€ -->
                            <div class="space-y-6 ${isLocked ? 'opacity-50 pointer-events-none' : ''}">
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                                    <!-- A. åŸºæœ¬è¨­ç½® (æ´»å‹•/æ–‡æ¡ˆ) -->
                                    <div class="lg:col-span-1 space-y-3">
                                        <h5 class="font-semibold text-red-600 mb-2 border-b pb-1">A. åŸºæœ¬è¨­ç½®</h5>
                                        
                                        <!-- A.i æ´»å‹•è³‡è¨Šèˆ‡çé …é…ç½® -->
                                        <h6 class="font-semibold text-gray-700">i. æ´»å‹•è³‡è¨Šèˆ‡çé …é…ç½®</h6>
                                        
                                        <label class="block text-sm font-medium text-gray-700">æ´»å‹•æ¨™é¡Œ:</label>
                                        <input type="text" id="config-title" placeholder="ä¾‹å¦‚: æ–°ç«¹æ¹–æ¿±æœƒé¤¨å°ˆå±¬ç¥¨é¸æ©Ÿ" value="${state.appTitle}" class="w-full p-2 border border-gray-300 rounded-md">
                                        
                                        <label class="block text-sm font-medium text-gray-700">æŠ•ç¥¨èªªæ˜æ–‡å­—:</label>
                                        <input type="text" id="config-vote-instruction" placeholder="è«‹åœ¨çœ¾å¤šç¦®ç‰©ä¸­ï¼Œé¸å‡ºæ‚¨å¿ƒç›®ä¸­çš„ X å€‹ç¦®ç‰©ï¼" value="${state.voteInstruction}" class="w-full p-2 border border-gray-300 rounded-md">
                                        
                                        <h6 class="font-semibold text-gray-700 border-t pt-4">ii. é–‹å ´èˆ‡è¦å‰‡æ–‡æ¡ˆ</h6>

                                        <label class="block text-sm font-medium text-gray-700">é–‹å ´æ¨™é¡Œ (Intro):</label>
                                        <input type="text" id="config-intro-heading" placeholder="ä¾‹å¦‚: è¦ªæ„›çš„å®¶äººå€‘ï¼Œæ­¡è¿åƒåŠ ..." value="${state.introHeading}" class="w-full p-2 border border-gray-300 rounded-md">

                                        <label class="block text-sm font-medium text-gray-700">é–‹å ´å‰¯æ¨™é¡Œ (Intro):</label>
                                        <input type="text" id="config-intro-subtext" placeholder="ä¾‹å¦‚: è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æŠ½å–..." value="${state.introSubtext}" class="w-full p-2 border border-gray-300 rounded-md">
                                        
                                        <label class="block text-sm font-medium text-gray-700">æµç¨‹æ¨™é¡Œ:</label>
                                        <input type="text" id="config-flow-heading" placeholder="ä¾‹å¦‚: äº¤æ›ç¦®ç‰©æµç¨‹ (7 æ­¥é©Ÿ)" value="${state.flowHeading}" class="w-full p-2 border border-gray-300 rounded-md">

                                        <label class="block text-sm font-medium text-gray-700">æµç¨‹å…§å®¹:</label>
                                        <textarea id="config-flow-content" placeholder="æ¢åˆ—å¼å¯«ä¸‹æµç¨‹" class="w-full p-2 border border-gray-300 rounded-md h-24">${state.flowContent}</textarea>
                                        
                                        <label class="block text-sm font-medium text-gray-700">è¦å‰‡æ¨™é¡Œ (Rules):</label>
                                        <input type="text" id="config-rules-heading" placeholder="ä¾‹å¦‚: ç¦®ç‰©äº¤æ›éŠæˆ²è¦å‰‡" value="${state.rulesHeading}" class="w-full p-2 border border-gray-300 rounded-md">

                                        <label class="block text-sm font-medium text-gray-700">è¦å‰‡å…§å®¹ (Rules):</label>
                                        <textarea id="config-rules-content" placeholder="æ¢åˆ—å¼å¯«ä¸‹è¦å‰‡" class="w-full p-2 border border-gray-300 rounded-md h-24">${state.rulesContent}</textarea>
                                    </div>

                                    <!-- B. çé …è¨­å®š -->
                                    <div class="lg:col-span-1 space-y-3">
                                        <h5 class="font-semibold text-red-600 mb-2 border-b pb-1">B. çé …è¨­å®š</h5>

                                        <label class="block text-sm font-medium text-gray-700">æ¦®è€€çé …æ•¸ (1-3å):</label>
                                        <input type="number" id="config-honor-ranks" min="0" max="3" placeholder="ä¾‹å¦‚: 3" value="${state.honorRanks}" class="w-full p-2 border border-gray-300 rounded-md">
                                        
                                        <label class="block text-sm font-medium text-gray-700">ç²ççå“æè¿°:</label>
                                        <input type="text" id="config-prize-desc" placeholder="ä¾‹å¦‚: è«‹å®¢å–é£²æ–™ä¸€è¼ªçš„æ®Šæ¦®ï¼" value="${state.prizeDescription}" class="w-full p-2 border border-gray-300 rounded-md">
                                    </div>
                                    
                                </div>
                                <!-- å„²å­˜é…ç½®æŒ‰éˆ• (æ»¿ç‰ˆ) -->
                                <button onclick="window.handleAdminAction('update-config')" class="w-full bg-red-600 text-white font-bold py-2 rounded-full hover:bg-red-700 transition">
                                    å„²å­˜é…ç½®
                                </button>
                            </div>
                        </div>
                    </div>


                    <!-- 3. ç¦®ç‰©é …ç›®ç®¡ç† (æ»¿ç‰ˆ) -->
                    <div class="w-full space-y-6 ${isLocked ? 'opacity-50 pointer-events-none' : ''}">
                        <h3 class="text-xl font-bold text-blue-700 border-b pb-2">ğŸ“¦ ç¦®ç‰©é …ç›®ç®¡ç†</h3>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                            <!-- B. å·¦å´ 2/3: æ–°å¢ç¦®ç‰©å€ (é …ç›®ä¸Šå‚³) -->
                            <div class="lg:col-span-2 space-y-6">
                                <!-- æ–°å¢ç¦®ç‰©å€ (åŒ¿åä¸Šå‚³) -->
                                <div class="border p-4 rounded-lg bg-white space-y-3">
                                    <h4 class="font-semibold text-red-600 mb-2 border-b pb-2">æ–°å¢ç¦®ç‰© (åŒ¿åä¸Šå‚³)</h4>
                                    
                                    <!-- åœ–ç‰‡é è¦½èˆ‡ä¸Šå‚³ -->
                                    <div class="flex items-center space-x-4">
                                        <img id="image-preview" src="${previewSrc}" alt="Image Preview" class="gift-image-preview rounded-lg border border-gray-300">
                                        <div>
                                            <label for="gift-image-input" class="block text-sm font-medium text-gray-700">é¸æ“‡ç¦®ç‰©ç…§ç‰‡</label>
                                            <input type="file" id="gift-image-input" accept="image/*" onchange="window.handleImageUpload(event)" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                                            <p class="text-xs text-gray-500 mt-1">å»ºè­°ä½¿ç”¨ 3:4 æ¯”ä¾‹åœ–ç‰‡</p>
                                            <p class="text-xs text-red-500">ç…§ç‰‡æœƒè‡ªå‹•å£“ç¸®è‡³ 400x400 åƒç´ ä»¥å…§ (é¿å…ä¸Šå‚³å¤±æ•—)</p>
                                        </div>
                                    </div>

                                    <textarea id="new-description" placeholder="ç¦®ç‰©ç°¡è¿° (ä¾‹å¦‚: æš–æš–ç³»æŒ‰æ‘©å„€)" class="w-full p-2 border border-red-300 rounded-md h-16"></textarea>
                                    
                                    <button onclick="window.handleAdminAction('add-gift')" class="w-full bg-red-600 text-white font-bold py-2 rounded-full hover:bg-red-700 transition">
                                        æ–°å¢ç¦®ç‰©
                                    </button>
                                </div>
                            </div>

                            <!-- C. å³å´ 1/3: å·²ä¸Šå‚³ç¦®ç‰©æ¸…å–® (æŸ¥é–±ç”¨) -->
                            <div class="lg:col-span-1 space-y-6">
                                <h3 class="text-xl font-bold text-blue-700 border-b pb-2">å·²ä¸Šå‚³ç¦®ç‰©æ¸…å–®</h3>
                                <div class="border p-4 rounded-lg bg-gray-100 space-y-3">
                                    <p class="text-xs text-gray-600 border-b pb-2">ç¦®ç‰©ç¸½æ•¸ï¼š${state.gifts.length} å€‹</p>
                                    <div class="max-h-80 overflow-y-auto space-y-2 py-2">
                                        ${state.gifts.length > 0 ? uploadedGiftsList : '<p class="text-sm text-gray-500">å°šç„¡ç¦®ç‰©å¯æŸ¥é–±ã€‚</p>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- 4. é«˜é¢¨éšªæ“ä½œ (æ”¶æŠ˜) -->
                    <div class="border p-0 rounded-lg bg-red-200">
                         <button onclick="window.toggleHighRisk()" 
                                class="w-full p-4 flex justify-between items-center font-bold text-red-700 bg-red-300 hover:bg-red-400 transition rounded-t-lg">
                            <span>ğŸš¨ é«˜é¢¨éšªæ“ä½œ (é‡ç½®/ç§»é™¤)</span>
                            <span>${state.isHighRiskOpen ? 'â–² éš±è—' : 'â–¼ å±•é–‹'}</span>
                        </button>
                        <div class="collapsible-content ${state.isHighRiskOpen ? 'max-h-full opacity-100 p-4' : 'max-h-0 opacity-0'}" style="max-height: ${state.isHighRiskOpen ? '800px' : '0px'};">
                            <div class="space-y-6">
                            
                                <!-- NEW: æ¸…é™¤åƒåŠ äººæ•¸ -->
                                <div class="border p-4 rounded-lg bg-yellow-50 border-yellow-300">
                                    <h4 class="font-semibold text-red-600 mb-2">ğŸ—‘ï¸ æ¸…é™¤åƒåŠ äººæ•¸</h4>
                                    <p class="text-xs text-gray-700 mb-3">æ­¤æ“ä½œå°‡äººæ•¸è¨­ç‚º 0ï¼Œå…è¨±åœ¨å–è™Ÿæ©Ÿé‡æ–°è¨­å®šï¼Œä¸å½±éŸ¿ç¦®ç‰©å’ŒæŠ•ç¥¨ç´€éŒ„ã€‚</p>
                                    <input type="password" id="clear-participants-password" placeholder="è«‹å†æ¬¡è¼¸å…¥ç®¡ç†å¯†ç¢¼" class="w-full p-2 mb-3 border border-yellow-400 rounded-md">
                                    <button onclick="window.handleAdminAction('clear-participants')" class="w-full bg-orange-500 text-white font-bold py-2 rounded-full hover:bg-orange-600 transition">
                                        æ¸…é™¤åƒåŠ äººæ•¸ (é‡è¨­)
                                    </button>
                                </div>
                            
                                <!-- å¼·åˆ¶ç§»é™¤å–®ä¸€æŠ•ç¥¨ç´€éŒ„ (ç¬¬ä¸€å€‹) -->
                                <div class="border p-4 rounded-lg bg-red-50 border-red-300">
                                    <h4 class="font-semibold text-red-600 mb-2">ğŸ—‘ï¸ å¼·åˆ¶ç§»é™¤å·²æŠ•ç¥¨ç·¨è™Ÿç´€éŒ„</h4>
                                    <p class="text-xs text-gray-700 mb-3">é©ç”¨æ–¼æœ‰äººæŠ•éŒ¯ç¥¨çš„æƒ…æ³ã€‚è¼¸å…¥ä»£è™Ÿå¾Œï¼Œè©²ä»£è™Ÿå³å¯é‡æ–°æŠ•ç¥¨ã€‚</p>
                                    <input type="text" id="remove-voter-id" placeholder="è¼¸å…¥æ¬²ç§»é™¤çš„æŠ•ç¥¨ç·¨è™Ÿ (ä¾‹å¦‚: 3)" class="w-full p-2 mb-3 border border-red-300 rounded-md ${isLocked ? 'bg-gray-300' : ''}" ${isLocked ? 'disabled' : ''}>
                                    <button onclick="window.handleAdminAction('force-remove-vote')" class="w-full bg-orange-500 text-white font-bold py-2 rounded-full hover:bg-orange-600 transition ${isLocked ? 'opacity-50 cursor-not-allowed' : ''}" ${isLocked ? 'disabled' : ''}>
                                        ç§»é™¤è©²ç·¨è™ŸæŠ•ç¥¨ç´€éŒ„
                                    </button>
                                </div>
                                
                                <!-- é‡ç½®éŠæˆ²å€ - å¿…é ˆè¼¸å…¥å¯†ç¢¼ (ç¬¬äºŒå€‹) -->
                                <div class="border p-4 rounded-lg bg-gray-200 border-red-600 border-dashed">
                                    <h4 class="font-semibold text-red-600 mb-2">âš¡ï¸ å®Œå…¨é‡ç½®éŠæˆ² (éœ€å¯†ç¢¼)</h4>
                                    <p class="text-xs text-gray-700 mb-3">æ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰ç¦®ç‰©ã€æ‰€æœ‰æŠ•ç¥¨å’Œäººæ•¸è¨­å®šï¼Œè«‹è¬¹æ…æ“ä½œï¼</p>
                                    <input type="password" id="reset-password" placeholder="è«‹å†æ¬¡è¼¸å…¥ç®¡ç†å¯†ç¢¼" class="w-full p-2 mb-3 border border-red-400 rounded-md focus:ring-red-500 focus:border-red-500 ${isLocked ? 'bg-gray-300' : ''}" ${isLocked ? 'disabled' : ''}>
                                    <button onclick="window.handleAdminAction('reset')" class="w-full bg-red-600 text-white font-bold py-2 rounded-full hover:bg-red-700 transition ${isLocked ? 'opacity-50 cursor-not-allowed' : ''}" ${isLocked ? 'disabled' : ''}>
                                        åŸ·è¡Œå®Œå…¨é‡ç½®
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderApp = () => {
            const appRoot = document.getElementById('app-root');
            if (state.loading) {
                appRoot.innerHTML = '<div class="text-center p-10 text-red-600"><svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> è¼‰å…¥ä¸­...</div>';
                return;
            }

            const ranking = calculateRanking();
            let content;

            switch (state.page) {
                case 'intro': 
                    content = renderIntroPanel();
                    break;
                case 'draw':
                    content = renderDrawPanel();
                    break;
                case 'vote':
                    content = renderGiftsList(state.gifts); 
                    break;
                case 'reveal': 
                    content = renderRevealPanel();
                    break;
                case 'ranking':
                    content = renderRanking(ranking);
                    break;
                case 'admin':
                    content = renderAdminPanel();
                    break;
                default:
                    content = 'é é¢éŒ¯èª¤ã€‚';
            }

            // è¨ˆç®—å·²æäº¤æŠ•ç¥¨çš„äººæ•¸
            const totalVotes = Object.keys(state.votes).filter(key => Array.isArray(state.votes[key]) && key !== '0' && state.votes[key].length > 0).length;

            appRoot.innerHTML = `
                ${renderMessage()}
                <div class="container mx-auto p-4 sm:p-6 lg:p-8">
                    <div class="bg-white card p-6 rounded-3xl shadow-2xl border-b-8 border-blue-700">
                        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-700 text-center mb-2 theme-header">ğŸ¾ ${state.appTitle} ğŸ‰</h1>
                        <p class="text-center text-gray-500 mb-6 font-medium">${state.voteInstruction}</p>
                        <p class="text-center text-sm font-semibold text-gray-700 mb-4 p-2 bg-yellow-50 rounded-lg">
                            ç•¶å‰å·²æäº¤æŠ•ç¥¨äººæ•¸ï¼š<span class="text-blue-700 font-extrabold text-lg">${totalVotes}</span> äºº
                        </p>

                        <!-- å°èˆªåˆ— -->
                        <div class="flex justify-center space-x-2 sm:space-x-4 mb-6">
                            <button onclick="window.setPage('intro')" class="px-4 py-2 rounded-full font-bold text-sm transition ${state.page === 'intro' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}">
                                é–‹å§‹
                            </button>
                            <button onclick="window.setPage('draw')" class="px-4 py-2 rounded-full font-bold text-sm transition ${state.page === 'draw' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}">
                                å–è™Ÿæ©Ÿ
                            </button>
                            <button onclick="window.setPage('vote')" class="px-4 py-2 rounded-full font-bold text-sm transition ${state.page === 'vote' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}">
                                æŠ•ç¥¨å€
                            </button>
                            <button onclick="window.setPage('reveal')" class="px-4 py-2 rounded-full font-bold text-sm transition ${state.page === 'reveal' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}">
                                æ­éœ²é€ç¦®è€…
                            </button>
                            <button onclick="window.setPage('ranking')" class="px-4 py-2 rounded-full font-bold text-sm transition ${state.page === 'ranking' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}">
                                çµæœæ’å
                            </button>
                            <button onclick="window.setPage('admin')" class="px-3 py-2 rounded-full text-xs font-bold transition ${state.page === 'admin' ? 'bg-red-600 text-white' : 'bg-red-100 text-red-600 hover:bg-red-200'}">
                                ç®¡ç†å“¡
                            </button>
                        </div>

                        <!-- å…§å®¹å€ -->
                        <div id="content-area" class="min-h-[400px]">
                            ${content}
                        </div>
                    </div>

                    <!-- å‚™è¨»/ç”¨æˆ¶ ID é¡¯ç¤º (ç§»é™¤ Firebase UID é¡¯ç¤º) -->
                    <div class="mt-6 text-center text-xs text-gray-400">
                        <p>æ¯å€‹æŠ•ç¥¨ä»£è™Ÿåªèƒ½æŠ•ç¥¨ä¸€æ¬¡ã€‚è«‹åœ¨æŠ•ç¥¨å‰å‹™å¿…ç¢ºèªä»£è™Ÿæ­£ç¢ºã€‚</p>
                    </div>
                </div>
                <!-- ç‘èŠ±ç²’å­å®¹å™¨ -->
                <div id="confetti-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000;"></div>
                
                ${renderRulesModal()}
                ${renderFlowModal()}
                ${renderRemarkModal()} <!-- NEW: å‚™è¨» Modal æ¸²æŸ“ -->
            `;
        };

        // --- å…¨åŸŸè®Šæ•¸/å‡½æ•¸ä¾› HTML èª¿ç”¨ ---
        window.selectVoterId = selectVoterId; 
        window.handleVoterSwitch = handleVoterSwitch; 
        window.handleSelection = handleSelection; 
        window.handleSubmitVotes = handleSubmitVotes; 
        window.handleAdminAction = handleAdminAction;
        window.handleAdminLockCheck = () => {
            const passwordInput = document.getElementById('admin-password');
            if (passwordInput && checkAdminLock(passwordInput.value)) {
                 passwordInput.value = ''; // æˆåŠŸå¾Œæ¸…ç©ºå¯†ç¢¼æ¬„ä½
            }
            renderApp();
        }
        window.handleImageUpload = handleImageUpload;
        window.handleNumberDraw = handleNumberDraw; // NEW: å–è™Ÿæ©ŸåŠŸèƒ½
        
        // NEW: è™•ç†é–‹å•Ÿå‚™è¨» Modal
        window.handleOpenRemarkModal = (number) => {
            state.currentRemarkNumber = number;
            state.isRemarkModalOpen = true;
            // Note: å¯¦éš›çš„ currentRemarkName æœƒåœ¨ Modal æ¸²æŸ“æ™‚å¾ state.participantNames[number] ä¸­è®€å–
            renderApp();
        };

        // NEW: è™•ç†é—œé–‰å‚™è¨» Modal
        window.handleCloseRemarkModal = () => {
            state.currentRemarkNumber = null;
            state.isRemarkModalOpen = false;
            renderApp();
        };

        // NEW: å…¨åŸŸå‡½æ•¸ä¾†è™•ç†é…ç½®é–‹é—œ
        window.toggleConfig = () => {
            state.isConfigOpen = !state.isConfigOpen;
            renderApp();
        };
        // NEW: å…¨åŸŸå‡½æ•¸ä¾†è™•ç†é«˜é¢¨éšªæ“ä½œå€å¡Šæ”¶æŠ˜
        window.toggleHighRisk = () => {
            state.isHighRiskOpen = !state.isHighRiskOpen;
            renderApp();
        };
        // NEW: å…¨åŸŸå‡½æ•¸ä¾†è™•ç†è¦å‰‡è·³çª—
        window.openRulesModal = () => {
            state.isRulesModalOpen = true;
            renderApp();
        };
        window.closeRulesModal = () => {
            state.isRulesModalOpen = false;
            renderApp();
        };
        // NEW: å…¨åŸŸå‡½æ•¸ä¾†è™•ç†æµç¨‹è·³çª—
        window.openFlowModal = () => {
            state.isFlowModalOpen = true;
            renderApp();
        };
        window.closeFlowModal = () => {
            state.isFlowModalOpen = false;
            renderApp();
        };
        window.setPage = (page) => {
            state.message = null; 
            state.page = page;
            renderApp();
        };
        // NEW: å°‡ç‘èŠ±å‡½æ•¸æ›è¼‰åˆ° window ä¸Š
        window.addConfettiEffect = () => {
            const confettiContainer = document.getElementById('confetti-container');
            if (!confettiContainer) return;

            const colors = ['#dc2626', '#fbbf24', '#1e40af', '#ffffff']; // ç´…, é‡‘, è—, ç™½
            const count = 50; // ç²’å­æ•¸é‡

            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                
                // éš¨æ©Ÿä½ç½®ã€é¡è‰²ã€å¤§å°å’Œå‹•ç•«å»¶é²
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${Math.random() * 8 + 4}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.animationDelay = `-${Math.random() * 1.5}s`; // è®“å®ƒå€‘ä¸€é–‹å§‹å°±åœ¨å‹•
                
                // ç§»é™¤å…ƒç´ ä»¥é˜²æ­¢ DOM å †ç©
                confetti.addEventListener('animationend', () => confetti.remove());
                
                confettiContainer.appendChild(confetti);
            }
        };

        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        initFirebase();
    </script>
</head>
<body>
    <div id="app-root">
        <!-- å…§å®¹å°‡ç”± JavaScript æ¸²æŸ“ -->
    </div>
</body>
</html>
